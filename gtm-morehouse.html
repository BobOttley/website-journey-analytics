<script>
(function(){
  var endpoint = "https://website-journey-analytics.onrender.com/api/event";
  var trackingKey = 'tk_morehouse_4682b67ae4980b95';

  // Visitor ID (persists across sessions for return visitor tracking)
  var visitorId = localStorage.getItem("wja_visitor_id");
  if (!visitorId) {
    visitorId = "v_" + Date.now() + "_" + Math.random().toString(36).substr(2,9);
    localStorage.setItem("wja_visitor_id", visitorId);
  }

  // Journey ID (per session)
  var journeyId = sessionStorage.getItem("wja_journey_id");
  var isReturnVisitor = false;
  if (!journeyId) {
    journeyId = "wja_" + Date.now() + "_" + Math.random().toString(36).substr(2,9);
    sessionStorage.setItem("wja_journey_id", journeyId);
    var lastVisit = localStorage.getItem("wja_last_visit");
    if (lastVisit) {
      isReturnVisitor = true;
    }
    localStorage.setItem("wja_last_visit", Date.now().toString());
  }

  var device = window.innerWidth < 768 ? "mobile" : (window.innerWidth < 1024 ? "tablet" : "desktop");
  var eventQueue = [];
  var maxScrollDepth = 0;

  function track(data) {
    data.journey_id = journeyId;
    data.visitor_id = visitorId;
    data.device_type = device;
    data.occurred_at = new Date().toISOString();
    data.tracking_key = trackingKey;
    eventQueue.push(data);
    if (eventQueue.length >= 10) {
      flushEvents();
    }
  }

  function flushEvents() {
    if (eventQueue.length === 0) return;
    var events = eventQueue.slice();
    eventQueue = [];
    navigator.sendBeacon(endpoint + "/batch", JSON.stringify({ events: events }));
  }

  // Page view
  track({
    event_type: "page_view",
    page_url: window.location.href,
    referrer: document.referrer,
    metadata: { title: document.title }
  });

  // Return visitor tracking
  if (isReturnVisitor) {
    var visitCount = parseInt(localStorage.getItem("wja_visit_count") || "1", 10) + 1;
    localStorage.setItem("wja_visit_count", visitCount.toString());
    track({ event_type: "return_visitor", page_url: window.location.href, metadata: { visit_count: visitCount } });
  } else {
    localStorage.setItem("wja_visit_count", "1");
  }

  // Heartbeat
  var hb = setInterval(function(){
    if (document.visibilityState === "visible") {
      track({ event_type: "heartbeat", page_url: window.location.href, metadata: { scroll_depth: maxScrollDepth } });
    }
  }, 30000);

  document.addEventListener("visibilitychange", function(){
    if (document.visibilityState === "hidden") {
      clearInterval(hb);
    }
  });

  // CTA clicks with intent detection
  document.addEventListener("click", function(e){
    var btn = e.target.closest("button, a.btn, .btn, a[href*=book], a[href*=enquir], a[href*=prospectus]");
    if (btn) {
      var label = btn.textContent.trim();
      var href = btn.href || "";
      var combined = (label + " " + href).toLowerCase();
      var intent = "explore";

      if (/prospectus|brochure/.test(combined)) {
        intent = "prospectus";
      } else if (/book|visit\s*us|open\s*day|taster|smart-bookings/.test(combined)) {
        intent = "book_visit";
      } else if (/enquir|get\s*in\s*touch|find\s*out\s*more/.test(combined)) {
        intent = "enquire";
      } else if (/apply|application|register/.test(combined)) {
        intent = "apply";
      } else if (/contact|call\s*us|email\s*us/.test(combined)) {
        intent = "contact";
      }

      track({
        event_type: "cta_click",
        page_url: window.location.href,
        cta_label: label.substring(0,100),
        intent_type: intent
      });
    }
  });

  // Scroll depth tracking
  var scrollTimeout;
  window.addEventListener("scroll", function() {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(function() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      var docHeight = document.documentElement.scrollHeight - window.innerHeight;
      var depth = docHeight > 0 ? Math.round((scrollTop / docHeight) * 100) : 0;
      if (depth > maxScrollDepth) {
        maxScrollDepth = depth;
        if ((depth === 25 || depth === 50 || depth === 75 || depth === 100) ||
            (depth > 25 && maxScrollDepth < 25) || (depth > 50 && maxScrollDepth < 50) ||
            (depth > 75 && maxScrollDepth < 75) || (depth > 90 && maxScrollDepth < 90)) {
          var milestone = depth >= 90 ? 100 : (depth >= 75 ? 75 : (depth >= 50 ? 50 : 25));
          track({ event_type: "scroll_depth", page_url: window.location.href, metadata: { depth: milestone } });
        }
      }
    }, 100);
  });

  // Dead click detection
  document.addEventListener("click", function(e) {
    var target = e.target;
    var tagName = target.tagName.toLowerCase();
    var isClickable = tagName === "a" || tagName === "button" || target.onclick || target.closest("a") || target.closest("button");
    if (!isClickable) {
      track({ event_type: "dead_click", page_url: window.location.href, metadata: { element: tagName, text: (target.textContent || "").substring(0, 50) } });
    }
  });

  // CTA hover tracking (hesitation detection)
  var ctaHoverTimeout;
  document.querySelectorAll("a, button, [role='button']").forEach(function(el) {
    el.addEventListener("mouseenter", function() {
      var element = this;
      ctaHoverTimeout = setTimeout(function() {
        track({ event_type: "cta_hover", page_url: window.location.href, metadata: { element: element.tagName.toLowerCase(), text: (element.textContent || "").substring(0, 50) } });
      }, 1000);
    });
    el.addEventListener("mouseleave", function() {
      clearTimeout(ctaHoverTimeout);
    });
  });

  // Rage click detection
  var clickTimes = [];
  document.addEventListener("click", function(e) {
    var now = Date.now();
    clickTimes.push(now);
    clickTimes = clickTimes.filter(function(t) { return now - t < 2000; });
    if (clickTimes.length >= 3) {
      track({ event_type: "rage_click", page_url: window.location.href, metadata: { element: e.target.tagName.toLowerCase(), clicks: clickTimes.length } });
      clickTimes = [];
    }
  });

  // Quick back detection
  var pageLoadTime = Date.now();
  window.addEventListener("beforeunload", function() {
    var timeOnPage = Date.now() - pageLoadTime;
    if (timeOnPage < 10000 && document.referrer.includes(window.location.hostname)) {
      track({ event_type: "quick_back", page_url: window.location.href, metadata: { time_on_page: timeOnPage } });
    }
    flushEvents();
  });

  // Text selection tracking
  document.addEventListener("mouseup", function() {
    var selection = window.getSelection().toString().trim();
    if (selection.length > 3 && selection.length < 500) {
      track({ event_type: "text_selection", page_url: window.location.href, metadata: { text: selection.substring(0, 100) } });
    }
  });

  // Site search tracking
  if (window.location.search.includes("s=") || window.location.search.includes("q=") || window.location.search.includes("search=")) {
    var params = new URLSearchParams(window.location.search);
    var query = params.get("s") || params.get("q") || params.get("search");
    if (query) {
      track({ event_type: "site_search", page_url: window.location.href, metadata: { query: query } });
    }
  }

  // Section visibility tracking
  if ("IntersectionObserver" in window) {
    var observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          var section = entry.target;
          var sectionId = section.id || section.className || section.tagName;
          track({ event_type: "section_visibility", page_url: window.location.href, metadata: { section: sectionId.substring(0, 50) } });
          observer.unobserve(section);
        }
      });
    }, { threshold: 0.5 });
    document.querySelectorAll("section, [class*='section'], main > div").forEach(function(el) {
      observer.observe(el);
    });
  }

  // PDF download tracking
  document.addEventListener("click", function(e) {
    var link = e.target.closest("a");
    if (link && link.href && link.href.toLowerCase().endsWith(".pdf")) {
      track({ event_type: "pdf_download", page_url: window.location.href, intent_type: "download", metadata: { url: link.href, text: (link.textContent || "").substring(0, 50) } });
    }
  });

  // Form tracking
  document.querySelectorAll("form").forEach(function(form) {
    var formId = form.id || form.name || "unnamed_form";
    var formStarted = false;
    form.querySelectorAll("input, textarea, select").forEach(function(field) {
      field.addEventListener("focus", function() {
        if (!formStarted) {
          formStarted = true;
          track({ event_type: "form_start", page_url: window.location.href, metadata: { form_id: formId } });
        }
        track({ event_type: "form_field_focus", page_url: window.location.href, metadata: { form_id: formId, field_name: field.name || field.id || "unnamed" } });
      });
      field.addEventListener("blur", function() {
        track({ event_type: "form_field_blur", page_url: window.location.href, metadata: { form_id: formId, field_name: field.name || field.id || "unnamed", has_value: !!field.value } });
      });
    });
    form.addEventListener("submit", function() {
      track({ event_type: "form_submit", page_url: window.location.href, metadata: { form_id: formId } });
    });
  });

  // Video tracking
  document.querySelectorAll("video, iframe[src*='youtube'], iframe[src*='vimeo']").forEach(function(video) {
    if (video.tagName === "VIDEO") {
      video.addEventListener("play", function() {
        track({ event_type: "video_play", page_url: window.location.href, metadata: { src: video.src || video.currentSrc } });
      });
      video.addEventListener("ended", function() {
        track({ event_type: "video_complete", page_url: window.location.href, metadata: { src: video.src || video.currentSrc } });
      });
    }
  });

  // Phone and email click tracking
  document.addEventListener("click", function(e) {
    var link = e.target.closest("a");
    if (link && link.href) {
      if (link.href.startsWith("tel:")) {
        track({ event_type: "cta_click", page_url: window.location.href, intent_type: "contact", cta_label: "Phone click", metadata: { action: "phone_click" } });
      } else if (link.href.startsWith("mailto:")) {
        track({ event_type: "cta_click", page_url: window.location.href, intent_type: "contact", cta_label: "Email click", metadata: { action: "email_click" } });
      }
    }
  });

  // Flush events periodically
  setInterval(flushEvents, 5000);
})();
</script>
