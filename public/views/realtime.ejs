<div class="flex justify-between items-center mb-4">
  <h2 style="font-size: 1.5rem; display: flex; align-items: center; gap: 12px;">
    <span class="live-dot"></span>
    Real-time Visitors
  </h2>
  <div class="flex gap-4 items-center">
    <span class="text-muted text-small" id="last-updated">Updated just now</span>
    <button class="btn btn-secondary btn-sm" onclick="refreshData()">Refresh</button>
  </div>
</div>

<% if (!emailConfigured) { %>
<div class="alert alert-warning">
  <strong>Email notifications disabled.</strong> Configure Microsoft Graph credentials to receive alerts for new visitors.
</div>
<% } %>

<!-- Active Visitors Stats -->
<div class="stats-grid">
  <div class="stat-card highlight">
    <h3>Active Now</h3>
    <div class="value" id="visitor-count"><%= visitorCount %></div>
    <div class="subtitle">Visitors in last 5 minutes</div>
  </div>
  <div class="stat-card">
    <h3>Status</h3>
    <div class="value" style="font-size: 1.25rem; display: flex; align-items: center; gap: 8px;">
      <span class="live-dot"></span>
      <span id="poll-status">Live</span>
    </div>
    <div class="subtitle">Refreshing every 10 seconds</div>
  </div>
  <div class="stat-card" id="locations-card">
    <h3>Locations</h3>
    <div class="value" id="locations-count">-</div>
    <div class="subtitle" id="locations-countries">Loading...</div>
  </div>
  <div class="stat-card">
    <h3>Return Rate</h3>
    <div class="value" id="return-rate">
      <%
        const returnVisitors = visitors.filter(v => v.visit_number && v.visit_number > 1).length;
        const returnRate = visitors.length > 0 ? ((returnVisitors / visitors.length) * 100).toFixed(0) : 0;
      %>
      <%= returnRate %>%
    </div>
    <div class="subtitle"><%= returnVisitors %> return visitors</div>
  </div>
</div>

<!-- Active Sessions Table -->
<div class="card" id="active-sessions-card">
  <h2>Active Sessions</h2>

  <div id="active-sessions-container">
    <% if (visitors.length === 0) { %>
    <div class="empty-state" id="no-visitors-message">
      <h3>No active visitors</h3>
      <p>Visitors will appear here when they're browsing your website.</p>
    </div>
    <% } %>
    <div style="overflow-x: auto; <%= visitors.length === 0 ? 'display: none;' : '' %>" id="visitors-table-container">
      <table id="visitors-table">
        <thead>
          <tr>
            <th>Location</th>
            <th>Current Page</th>
            <th>Referrer</th>
            <th>Device</th>
            <th>Visitor</th>
            <th>Session Started</th>
            <th>Last Activity</th>
            <th>Journey</th>
          </tr>
        </thead>
        <tbody>
          <% visitors.forEach(visitor => { %>
          <tr data-journey="<%= visitor.journey_id %>">
            <td>
              <% if (visitor.location && visitor.location.countryCode) { %>
                <span class="text-small"><%= visitor.location.city || visitor.location.country || visitor.location.countryCode %></span>
              <% } else { %>
                <span class="text-muted">Unknown</span>
              <% } %>
            </td>
            <td>
              <a href="<%= visitor.page_url %>" target="_blank" title="<%= visitor.page_url %>">
                <%= visitor.page_url ? visitor.page_url.replace(/^https?:\/\/[^\/]+/, '').substring(0, 40) : 'Unknown' %><%= visitor.page_url && visitor.page_url.replace(/^https?:\/\/[^\/]+/, '').length > 40 ? '...' : '' %>
              </a>
            </td>
            <td>
              <% if (visitor.referrer) { %>
              <span title="<%= visitor.referrer %>"><%= visitor.referrer.replace(/^https?:\/\/([^\/]+).*/, '$1').substring(0, 25) %></span>
              <% } else { %>
              <span class="text-muted">Direct</span>
              <% } %>
            </td>
            <td>
              <span class="badge badge-<%= visitor.device_type === 'mobile' ? 'warning' : visitor.device_type === 'tablet' ? 'info' : 'neutral' %>">
                <%= visitor.device_type || 'Unknown' %>
              </span>
            </td>
            <td>
              <% if (visitor.visit_number && visitor.visit_number > 1) { %>
                <span class="badge badge-gold">Return</span>
              <% } else { %>
                <span class="badge badge-neutral">New</span>
              <% } %>
            </td>
            <td><%= new Date(visitor.first_seen).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) %></td>
            <td class="last-activity"><%= new Date(visitor.last_activity).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) %></td>
            <td>
              <a href="/journeys/<%= visitor.journey_id %>" class="btn btn-outline btn-sm">View</a>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Recent Sessions (Ended in last 10 mins) -->
<div class="card" id="recent-sessions-card">
  <h2>Recent Sessions</h2>
  <p class="text-muted text-small mb-4">Latest 10 completed sessions</p>

  <div id="recent-sessions-content">
    <div class="empty-state">
      <p class="text-muted">Loading recent sessions...</p>
    </div>
  </div>
</div>

<style>
  #visitors-table tbody tr,
  #recent-sessions-table tbody tr {
    transition: background-color 0.3s;
  }

  #visitors-table tbody tr.new-visitor {
    background: linear-gradient(90deg, rgba(16, 185, 129, 0.15) 0%, transparent 100%);
  }

  .visitor-count-change {
    animation: countPulse 0.5s ease-out;
  }

  @keyframes countPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.15); }
    100% { transform: scale(1); }
  }
</style>

<script>
  let pollInterval = null;
  let lastPollTime = Date.now();
  let previousJourneyIds = new Set(<%- JSON.stringify(visitors.map(v => v.journey_id)) %>);

  // Page name helpers (local copy to avoid any scoping issues)
  const PAGE_NAMES_LOCAL = {
    '/': 'Home',
    '/index.html': 'Home',
    '/crm.html': 'SMART CRM',
    '/prospectus.html': 'SMART Prospectus',
    '/chatbot.html': 'Emily',
    '/voice.html': 'SMART Voice',
    '/booking.html': 'SMART Booking',
    '/email.html': 'SMART Email',
    '/contact.html': 'Contact',
    '/smart-benefits-calculator.html': 'ROI Calculator',
    '/privacy.html': 'Privacy Policy'
  };

  function getPageNameLocal(url) {
    if (!url) return 'Unknown';
    let path = url;
    try {
      if (url.startsWith('http')) {
        path = new URL(url).pathname;
      }
    } catch (e) {
      path = url.replace(/https?:\/\/[^\/]+/, '');
    }
    path = path.split('?')[0].toLowerCase();
    return PAGE_NAMES_LOCAL[path] || PAGE_NAMES_LOCAL[path.replace(/^\//, '')] || formatPageNameLocal(path);
  }

  function formatPageNameLocal(path) {
    let name = path.replace(/^\//, '').replace('.html', '').replace(/-/g, ' ');
    if (!name || name === '/') return 'Home';
    return name.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
  }

  function getPageIconLocal(url) {
    return ''; // No icons for now
  }

  function formatTime(date) {
    return new Date(date).toLocaleTimeString('en-GB', {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
  }

  function truncateUrl(url, maxLength = 40) {
    if (!url) return 'Unknown';
    const path = url.replace(/^https?:\/\/[^\/]+/, '');
    return path.length > maxLength ? path.substring(0, maxLength) + '...' : path;
  }

  function truncateDomain(url, maxLength = 25) {
    if (!url) return '';
    const match = url.match(/^https?:\/\/([^\/]+)/);
    const domain = match ? match[1] : url;
    return domain.length > maxLength ? domain.substring(0, maxLength) + '...' : domain;
  }

  function updateLastUpdated() {
    const seconds = Math.round((Date.now() - lastPollTime) / 1000);
    const text = seconds < 5 ? 'Updated just now' : `Updated ${seconds}s ago`;
    document.getElementById('last-updated').textContent = text;
  }

  async function refreshData() {
    try {
      const response = await fetch('/realtime/api/visitors?seconds=300');
      const data = await response.json();

      if (!data.success) {
        console.error('Failed to fetch visitors:', data.error);
        return;
      }

      lastPollTime = Date.now();
      updateLastUpdated();

      // Update visitor count with animation
      const countEl = document.getElementById('visitor-count');
      const oldCount = parseInt(countEl.textContent);
      if (oldCount !== data.count) {
        countEl.textContent = data.count;
        countEl.classList.add('visitor-count-change');
        setTimeout(() => countEl.classList.remove('visitor-count-change'), 500);
      }

      // Calculate return rate
      const returnVisitors = data.visitors.filter(v => v.visit_number ? v.visit_number > 1 : false).length;
      const returnRate = data.visitors.length > 0 ? ((returnVisitors / data.visitors.length) * 100).toFixed(0) : 0;
      document.getElementById('return-rate').textContent = returnRate + '%';

      // Update locations
      const locationMap = {};
      data.visitors.forEach(v => {
        if (v.location ? v.location.countryCode : false) {
          const code = v.location.countryCode;
          if (!locationMap[code]) {
            locationMap[code] = { country: v.location.country, count: 0 };
          }
          locationMap[code].count++;
        }
      });
      const locations = Object.values(locationMap).sort((a, b) => b.count - a.count);
      const uniqueCountries = locations.length;
      document.getElementById('locations-count').textContent = uniqueCountries;
      document.getElementById('locations-countries').textContent = locations.slice(0, 3).map(l => l.country).join(', ') || 'No data';

      // Update table
      const tbody = document.querySelector('#visitors-table tbody');
      const tableContainer = document.getElementById('visitors-table-container');
      const emptyMessage = document.getElementById('no-visitors-message');

      if (data.visitors.length === 0) {
        if (tableContainer) tableContainer.style.display = 'none';
        if (emptyMessage) {
          emptyMessage.style.display = 'block';
        } else {
          // Create empty message if it doesn't exist
          const container = document.getElementById('active-sessions-container');
          if (container) {
            const msg = document.createElement('div');
            msg.className = 'empty-state';
            msg.id = 'no-visitors-message';
            msg.innerHTML = '<h3>No active visitors</h3><p>Visitors will appear here when they\'re browsing your website.</p>';
            container.insertBefore(msg, tableContainer);
          }
        }
        previousJourneyIds.clear();
        return;
      }

      // Show table, hide empty message
      if (tableContainer) tableContainer.style.display = 'block';
      if (emptyMessage) emptyMessage.style.display = 'none';

      if (tbody) {
        const currentJourneyIds = new Set(data.visitors.map(v => v.journey_id));
        const newJourneyIds = new Set();

        currentJourneyIds.forEach(id => {
          if (!previousJourneyIds.has(id)) {
            newJourneyIds.add(id);
          }
        });

        tbody.innerHTML = data.visitors.map(v => {
          const isNew = newJourneyIds.has(v.journey_id);
          const deviceBadge = v.device_type === 'mobile' ? 'warning' : v.device_type === 'tablet' ? 'info' : 'neutral';
          const referrerHtml = v.referrer
            ? `<span title="${v.referrer}">${truncateDomain(v.referrer)}</span>`
            : '<span class="text-muted">Direct</span>';
          const hasLocation = v.location ? v.location.countryCode : false;
          const locationHtml = hasLocation
            ? `<span class="text-small">${v.location.city || v.location.country || v.location.countryCode}</span>`
            : '<span class="text-muted">Unknown</span>';
          const isReturnVisitor = v.visit_number ? v.visit_number > 1 : false;
          const visitorBadge = isReturnVisitor
            ? '<span class="badge badge-gold">Return</span>'
            : '<span class="badge badge-neutral">New</span>';

          return `
            <tr data-journey="${v.journey_id}" class="${isNew ? 'new-visitor' : ''}">
              <td>${locationHtml}</td>
              <td><a href="${v.page_url}" target="_blank" title="${v.page_url}">${truncateUrl(v.page_url)}</a></td>
              <td>${referrerHtml}</td>
              <td><span class="badge badge-${deviceBadge}">${v.device_type || 'Unknown'}</span></td>
              <td>${visitorBadge}</td>
              <td>${formatTime(v.first_seen)}</td>
              <td class="last-activity">${formatTime(v.last_activity)}</td>
              <td><a href="/journeys/${v.journey_id}" class="btn btn-outline btn-sm">View</a></td>
            </tr>
          `;
        }).join('');

        setTimeout(() => {
          document.querySelectorAll('.new-visitor').forEach(el => {
            el.classList.remove('new-visitor');
          });
        }, 2000);

        previousJourneyIds = currentJourneyIds;
      }

      fetch('/realtime/api/new-journeys?seconds=300').catch(console.error);

    } catch (error) {
      console.error('Error refreshing data:', error);
    }
  }

  async function loadRecentSessions() {
    const container = document.getElementById('recent-sessions-content');
    if (!container) {
      console.error('Recent sessions container not found');
      return;
    }

    try {
      console.log('Fetching recent sessions...');
      const response = await fetch('/realtime/api/recent-sessions?_t=' + Date.now());

      if (!response.ok) {
        const text = await response.text();
        console.error('API error response:', text.substring(0, 200));
        throw new Error('Server returned ' + response.status);
      }

      const data = await response.json();
      console.log('Recent sessions data:', data);

      if (!data.success) {
        console.error('API returned success=false:', data.error);
        throw new Error(data.error || 'API error');
      }

      if (!data.sessions || data.sessions.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p class="text-muted">No completed sessions yet.</p>
          </div>
        `;
        return;
      }

      const tableHtml = `
        <div style="overflow-x: auto;">
          <table id="recent-sessions-table">
            <thead>
              <tr>
                <th>Location</th>
                <th>Entry Page</th>
                <th>Pages</th>
                <th>Device</th>
                <th>Visitor</th>
                <th>Started</th>
                <th>Ended</th>
                <th>Journey</th>
              </tr>
            </thead>
            <tbody>
              ${data.sessions.map(s => {
                const location = s.location
                  ? `<span class="text-small">${s.location.city || s.location.country || s.location.countryCode}</span>`
                  : '<span class="text-muted">Unknown</span>';
                const entryPage = s.entry_page
                  ? `<span title="${s.entry_page}">${getPageNameLocal(s.entry_page)}</span>`
                  : '<span class="text-muted">Unknown</span>';
                const deviceBadge = s.device_type === 'mobile' ? 'warning' : s.device_type === 'tablet' ? 'info' : 'neutral';
                const isReturn = s.visit_number ? s.visit_number > 1 : false;
                const visitorBadge = isReturn
                  ? '<span class="badge badge-gold">Return</span>'
                  : '<span class="badge badge-neutral">New</span>';
                const outcomeBadge = s.outcome === 'enquiry_submitted' || s.outcome === 'visit_booked'
                  ? `<span class="badge badge-success" style="margin-left: 4px;">âœ“</span>`
                  : '';

                return `
                  <tr>
                    <td>${location}</td>
                    <td>${entryPage}</td>
                    <td>${s.event_count || '-'}</td>
                    <td><span class="badge badge-${deviceBadge}">${s.device_type || 'Unknown'}</span></td>
                    <td>${visitorBadge}${outcomeBadge}</td>
                    <td>${formatTime(s.first_seen)}</td>
                    <td>${formatTime(s.last_seen)}</td>
                    <td><a href="/journeys/${s.journey_id}" class="btn btn-outline btn-sm">View</a></td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = tableHtml;
    } catch (error) {
      console.error('Error loading recent sessions:', error);
      console.error('Error stack:', error.stack);
      container.innerHTML = `
        <div class="empty-state">
          <p class="text-muted">Failed to load recent sessions.</p>
          <p class="text-muted text-small" style="margin-top: 8px; opacity: 0.7;">${error.message}</p>
        </div>
      `;
    }
  }

  function startPolling() {
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(refreshData, 10000);
    setInterval(updateLastUpdated, 1000);

    // Load data immediately, then refresh periodically
    refreshData();
    loadRecentSessions();
    setInterval(loadRecentSessions, 30000);
  }

  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
    } else {
      refreshData();
      startPolling();
    }
  });

  startPolling();
</script>
