<div class="flex justify-between items-center mb-4">
  <h2 style="font-size: 1.5rem; display: flex; align-items: center; gap: 12px;">
    <span class="live-dot"></span>
    Real-time Visitors
  </h2>
  <div class="flex gap-4 items-center">
    <span class="text-muted text-small" id="last-updated">Updated just now</span>
    <button class="btn btn-secondary btn-sm" onclick="refreshData()">
      üîÑ Refresh
    </button>
  </div>
</div>

<% if (!emailConfigured) { %>
<div class="alert alert-warning">
  <span>‚ö†Ô∏è</span>
  <span><strong>Email notifications disabled.</strong> Configure Microsoft Graph credentials to receive alerts for new visitors.</span>
</div>
<% } %>

<!-- Active Visitors Stats -->
<div class="stats-grid">
  <div class="stat-card highlight">
    <div class="icon pulse" style="background: linear-gradient(135deg, var(--success) 0%, #34D399 100%); color: white;">üë•</div>
    <h3>Active Now</h3>
    <div class="value" id="visitor-count"><%= visitorCount %></div>
    <div class="subtitle">Visitors in last 60 seconds</div>
  </div>
  <div class="stat-card">
    <div class="icon">üì°</div>
    <h3>Status</h3>
    <div class="value" style="font-size: 1.25rem; display: flex; align-items: center; gap: 8px;">
      <span class="live-dot"></span>
      <span id="poll-status">Live</span>
    </div>
    <div class="subtitle">Refreshing every 10 seconds</div>
  </div>
  <div class="stat-card" id="locations-card">
    <div class="icon">üåç</div>
    <h3>Locations</h3>
    <div class="value" id="locations-count">-</div>
    <div class="subtitle" id="locations-countries">Loading...</div>
  </div>
  <div class="stat-card">
    <div class="icon">‚Ü©Ô∏è</div>
    <h3>Return Rate</h3>
    <div class="value" id="return-rate">
      <%
        const returnVisitors = visitors.filter(v => v.visit_number && v.visit_number > 1).length;
        const returnRate = visitors.length > 0 ? ((returnVisitors / visitors.length) * 100).toFixed(0) : 0;
      %>
      <%= returnRate %>%
    </div>
    <div class="subtitle"><%= returnVisitors %> return visitors</div>
  </div>
</div>

<!-- Live Activity Feed & Visitors Table -->
<div class="grid-2 mb-6">
  <!-- Live Activity Feed -->
  <div class="card" style="max-height: 400px; overflow: hidden;">
    <h2>Live Activity Feed</h2>
    <div id="activity-feed" style="max-height: 300px; overflow-y: auto;">
      <% if (visitors.length === 0) { %>
        <div class="empty-state" style="padding: 40px 20px;">
          <div class="icon">üì≠</div>
          <h3>No activity yet</h3>
          <p class="text-small">Waiting for visitors...</p>
        </div>
      <% } else { %>
        <div id="feed-items">
          <% visitors.slice(0, 10).forEach((visitor, index) => { %>
            <div class="activity-item slide-in" style="animation-delay: <%= index * 0.1 %>s; display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border-color);">
              <div style="width: 40px; height: 40px; border-radius: 10px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center;">
                <% if (visitor.location && visitor.location.flag) { %>
                  <span style="font-size: 20px;"><%= visitor.location.flag %></span>
                <% } else { %>
                  <span style="font-size: 16px;">üë§</span>
                <% } %>
              </div>
              <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                  <% if (visitor.page_url) { %>
                    <%= visitor.page_url.replace(/^https?:\/\/[^\/]+/, '').substring(0, 35) %><%= visitor.page_url.replace(/^https?:\/\/[^\/]+/, '').length > 35 ? '...' : '' %>
                  <% } else { %>
                    Unknown page
                  <% } %>
                </div>
                <div class="text-small text-muted">
                  <% if (visitor.location && visitor.location.city) { %>
                    <%= visitor.location.city %>, <%= visitor.location.countryCode %>
                  <% } else { %>
                    Location unknown
                  <% } %>
                </div>
              </div>
              <div class="text-small text-muted">
                <%= new Date(visitor.last_activity).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) %>
              </div>
            </div>
          <% }) %>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Location Summary -->
  <div class="card" style="max-height: 400px; overflow: hidden;">
    <h2>Visitor Locations</h2>
    <div id="locations-list" style="max-height: 300px; overflow-y: auto;">
      <%
        const locationMap = {};
        visitors.forEach(v => {
          if (v.location && v.location.countryCode) {
            const code = v.location.countryCode;
            if (!locationMap[code]) {
              locationMap[code] = {
                country: v.location.country,
                countryCode: code,
                flag: v.location.flag,
                count: 0,
                cities: new Set()
              };
            }
            locationMap[code].count++;
            if (v.location.city) locationMap[code].cities.add(v.location.city);
          }
        });
        const locations = Object.values(locationMap).sort((a, b) => b.count - a.count);
      %>
      <% if (locations.length === 0) { %>
        <div class="empty-state" style="padding: 40px 20px;">
          <div class="icon">üó∫Ô∏è</div>
          <h3>No location data</h3>
          <p class="text-small">Location tracking requires public IP addresses</p>
        </div>
      <% } else { %>
        <% locations.forEach(loc => { %>
          <div style="display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border-color);">
            <span style="font-size: 24px;"><%= loc.flag %></span>
            <div style="flex: 1;">
              <div style="font-weight: 500;"><%= loc.country %></div>
              <div class="text-small text-muted">
                <% const cities = Array.from(loc.cities); %>
                <%= cities.slice(0, 3).join(', ') %><%= cities.length > 3 ? ' +' + (cities.length - 3) + ' more' : '' %>
              </div>
            </div>
            <div class="badge badge-gold"><%= loc.count %></div>
          </div>
        <% }) %>
      <% } %>
    </div>
  </div>
</div>

<!-- Active Sessions Table -->
<div class="card">
  <h2>Active Sessions</h2>

  <% if (visitors.length === 0) { %>
  <div class="empty-state">
    <div class="icon">üëÄ</div>
    <h3>No active visitors</h3>
    <p>Visitors will appear here when they're browsing your website.</p>
  </div>
  <% } else { %>
  <div style="overflow-x: auto;">
    <table id="visitors-table">
      <thead>
        <tr>
          <th>Location</th>
          <th>Current Page</th>
          <th>Referrer</th>
          <th>Device</th>
          <th>Visitor</th>
          <th>Session Started</th>
          <th>Last Activity</th>
          <th>Journey</th>
        </tr>
      </thead>
      <tbody>
        <% visitors.forEach(visitor => { %>
        <tr data-journey="<%= visitor.journey_id %>">
          <td>
            <% if (visitor.location && visitor.location.flag) { %>
              <span class="country-flag"><%= visitor.location.flag %></span>
              <span class="text-small"><%= visitor.location.city || visitor.location.country || '-' %></span>
            <% } else { %>
              <span class="text-muted">üåç Unknown</span>
            <% } %>
          </td>
          <td>
            <a href="<%= visitor.page_url %>" target="_blank" title="<%= visitor.page_url %>">
              <%= visitor.page_url ? visitor.page_url.replace(/^https?:\/\/[^\/]+/, '').substring(0, 40) : 'Unknown' %><%= visitor.page_url && visitor.page_url.replace(/^https?:\/\/[^\/]+/, '').length > 40 ? '...' : '' %>
            </a>
          </td>
          <td>
            <% if (visitor.referrer) { %>
            <span title="<%= visitor.referrer %>"><%= visitor.referrer.replace(/^https?:\/\/([^\/]+).*/, '$1').substring(0, 25) %></span>
            <% } else { %>
            <span class="text-muted">Direct</span>
            <% } %>
          </td>
          <td>
            <span class="badge badge-<%= visitor.device_type === 'mobile' ? 'warning' : visitor.device_type === 'tablet' ? 'info' : 'neutral' %>">
              <%= visitor.device_type || 'Unknown' %>
            </span>
          </td>
          <td>
            <% if (visitor.visit_number && visitor.visit_number > 1) { %>
              <span class="badge badge-return">‚Ü© Return</span>
            <% } else { %>
              <span class="badge badge-neutral">New</span>
            <% } %>
          </td>
          <td><%= new Date(visitor.first_seen).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) %></td>
          <td class="last-activity"><%= new Date(visitor.last_activity).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) %></td>
          <td>
            <a href="/journeys/<%= visitor.journey_id %>" class="btn btn-outline btn-sm">
              View ‚Üí
            </a>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>
  </div>
  <% } %>
</div>

<style>
  #visitors-table tbody tr {
    transition: background-color 0.3s;
  }

  #visitors-table tbody tr.new-visitor {
    background: linear-gradient(90deg, rgba(16, 185, 129, 0.15) 0%, transparent 100%);
    animation: newVisitorGlow 1s ease-out;
  }

  @keyframes newVisitorGlow {
    0% { box-shadow: inset 0 0 0 2px var(--success); }
    100% { box-shadow: inset 0 0 0 0 transparent; }
  }

  #visitors-table tbody tr.fading {
    background-color: rgba(245, 158, 11, 0.1);
  }

  .visitor-count-change {
    animation: countPulse 0.5s ease-out;
  }

  @keyframes countPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.15); }
    100% { transform: scale(1); }
  }

  .activity-item {
    transition: background-color 0.2s;
  }

  .activity-item:hover {
    background: var(--bg-secondary);
  }

  .activity-item.new {
    animation: slideIn 0.3s ease-out, newItemGlow 1s ease-out;
  }

  @keyframes newItemGlow {
    0% { background: rgba(16, 185, 129, 0.2); }
    100% { background: transparent; }
  }
</style>

<script>
  let pollInterval = null;
  let lastPollTime = Date.now();
  let previousJourneyIds = new Set(<%= JSON.stringify(visitors.map(v => v.journey_id)) %>);

  function formatTime(date) {
    return new Date(date).toLocaleTimeString('en-GB', {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
  }

  function truncateUrl(url, maxLength = 40) {
    if (!url) return 'Unknown';
    const path = url.replace(/^https?:\/\/[^\/]+/, '');
    return path.length > maxLength ? path.substring(0, maxLength) + '...' : path;
  }

  function truncateDomain(url, maxLength = 25) {
    if (!url) return '';
    const match = url.match(/^https?:\/\/([^\/]+)/);
    const domain = match ? match[1] : url;
    return domain.length > maxLength ? domain.substring(0, maxLength) + '...' : domain;
  }

  function updateLastUpdated() {
    const seconds = Math.round((Date.now() - lastPollTime) / 1000);
    const text = seconds < 5 ? 'Updated just now' : `Updated ${seconds}s ago`;
    document.getElementById('last-updated').textContent = text;
  }

  async function refreshData() {
    try {
      const response = await fetch('/realtime/api/visitors?seconds=60');
      const data = await response.json();

      if (!data.success) {
        console.error('Failed to fetch visitors:', data.error);
        return;
      }

      lastPollTime = Date.now();
      updateLastUpdated();

      // Update visitor count with animation
      const countEl = document.getElementById('visitor-count');
      const oldCount = parseInt(countEl.textContent);
      if (oldCount !== data.count) {
        countEl.textContent = data.count;
        countEl.classList.add('visitor-count-change');
        setTimeout(() => countEl.classList.remove('visitor-count-change'), 500);
      }

      // Calculate return rate
      const returnVisitors = data.visitors.filter(v => v.visit_number && v.visit_number > 1).length;
      const returnRate = data.visitors.length > 0 ? ((returnVisitors / data.visitors.length) * 100).toFixed(0) : 0;
      document.getElementById('return-rate').textContent = returnRate + '%';

      // Update locations
      const locationMap = {};
      data.visitors.forEach(v => {
        if (v.location && v.location.countryCode) {
          const code = v.location.countryCode;
          if (!locationMap[code]) {
            locationMap[code] = { country: v.location.country, flag: v.location.flag, count: 0 };
          }
          locationMap[code].count++;
        }
      });
      const locations = Object.values(locationMap).sort((a, b) => b.count - a.count);
      const uniqueCountries = locations.length;
      document.getElementById('locations-count').textContent = uniqueCountries;
      document.getElementById('locations-countries').textContent = locations.slice(0, 3).map(l => l.flag).join(' ') || 'No data';

      // Update table
      const tbody = document.querySelector('#visitors-table tbody');
      const card = document.querySelector('.card:last-child');

      if (data.visitors.length === 0) {
        if (tbody) {
          const tableContainer = document.querySelector('#visitors-table').closest('div[style*="overflow"]');
          if (tableContainer) {
            tableContainer.innerHTML = `
              <div class="empty-state">
                <div class="icon">üëÄ</div>
                <h3>No active visitors</h3>
                <p>Visitors will appear here when they're browsing your website.</p>
              </div>
            `;
          }
        }
        previousJourneyIds.clear();
        return;
      }

      if (tbody) {
        const currentJourneyIds = new Set(data.visitors.map(v => v.journey_id));
        const newJourneyIds = new Set();

        currentJourneyIds.forEach(id => {
          if (!previousJourneyIds.has(id)) {
            newJourneyIds.add(id);
          }
        });

        tbody.innerHTML = data.visitors.map(v => {
          const isNew = newJourneyIds.has(v.journey_id);
          const deviceBadge = v.device_type === 'mobile' ? 'warning' : v.device_type === 'tablet' ? 'info' : 'neutral';
          const referrerHtml = v.referrer
            ? `<span title="${v.referrer}">${truncateDomain(v.referrer)}</span>`
            : '<span class="text-muted">Direct</span>';
          const locationHtml = v.location && v.location.flag
            ? `<span class="country-flag">${v.location.flag}</span><span class="text-small">${v.location.city || v.location.country || '-'}</span>`
            : '<span class="text-muted">üåç Unknown</span>';
          const visitorBadge = v.visit_number && v.visit_number > 1
            ? '<span class="badge badge-return">‚Ü© Return</span>'
            : '<span class="badge badge-neutral">New</span>';

          return `
            <tr data-journey="${v.journey_id}" class="${isNew ? 'new-visitor' : ''}">
              <td>${locationHtml}</td>
              <td><a href="${v.page_url}" target="_blank" title="${v.page_url}">${truncateUrl(v.page_url)}</a></td>
              <td>${referrerHtml}</td>
              <td><span class="badge badge-${deviceBadge}">${v.device_type || 'Unknown'}</span></td>
              <td>${visitorBadge}</td>
              <td>${formatTime(v.first_seen)}</td>
              <td class="last-activity">${formatTime(v.last_activity)}</td>
              <td><a href="/journeys/${v.journey_id}" class="btn btn-outline btn-sm">View ‚Üí</a></td>
            </tr>
          `;
        }).join('');

        // Remove new-visitor class after animation
        setTimeout(() => {
          document.querySelectorAll('.new-visitor').forEach(el => {
            el.classList.remove('new-visitor');
          });
        }, 2000);

        previousJourneyIds = currentJourneyIds;
      }

      // Also check for new journeys (to trigger email notifications)
      fetch('/realtime/api/new-journeys?seconds=60').catch(console.error);

    } catch (error) {
      console.error('Error refreshing data:', error);
    }
  }

  // Start polling
  function startPolling() {
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(refreshData, 10000);
    setInterval(updateLastUpdated, 1000);
  }

  // Stop polling when page is hidden
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
    } else {
      refreshData();
      startPolling();
    }
  });

  // Initial start
  startPolling();
</script>
