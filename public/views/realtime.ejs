<div class="flex justify-between items-center mb-4">
  <h2 style="font-size: 1.5rem; display: flex; align-items: center; gap: 12px;">
    <span class="live-dot"></span>
    Real-time Visitors
  </h2>
  <div class="flex gap-4 items-center">
    <span class="text-muted text-small" id="last-updated">Updated just now</span>
    <button class="btn btn-secondary btn-sm" onclick="refreshData()">Refresh</button>
  </div>
</div>

<% if (!emailConfigured) { %>
<div class="alert alert-warning">
  <strong>Email notifications disabled.</strong> Configure Microsoft Graph credentials to receive alerts for new visitors.
</div>
<% } %>

<!-- Active Visitors Stats -->
<div class="stats-grid">
  <div class="stat-card highlight">
    <h3>Active Now</h3>
    <div class="value" id="visitor-count"><%= visitorCount %></div>
    <div class="subtitle">Visitors in last 60 seconds</div>
  </div>
  <div class="stat-card">
    <h3>Status</h3>
    <div class="value" style="font-size: 1.25rem; display: flex; align-items: center; gap: 8px;">
      <span class="live-dot"></span>
      <span id="poll-status">Live</span>
    </div>
    <div class="subtitle">Refreshing every 10 seconds</div>
  </div>
  <div class="stat-card" id="locations-card">
    <h3>Locations</h3>
    <div class="value" id="locations-count">-</div>
    <div class="subtitle" id="locations-countries">Loading...</div>
  </div>
  <div class="stat-card">
    <h3>Return Rate</h3>
    <div class="value" id="return-rate">
      <%
        const returnVisitors = visitors.filter(v => v.visit_number && v.visit_number > 1).length;
        const returnRate = visitors.length > 0 ? ((returnVisitors / visitors.length) * 100).toFixed(0) : 0;
      %>
      <%= returnRate %>%
    </div>
    <div class="subtitle"><%= returnVisitors %> return visitors</div>
  </div>
</div>

<!-- Active Sessions Table -->
<div class="card">
  <h2>Active Sessions</h2>

  <% if (visitors.length === 0) { %>
  <div class="empty-state">
    <h3>No active visitors</h3>
    <p>Visitors will appear here when they're browsing your website.</p>
  </div>
  <% } else { %>
  <div style="overflow-x: auto;">
    <table id="visitors-table">
      <thead>
        <tr>
          <th>Location</th>
          <th>Current Page</th>
          <th>Referrer</th>
          <th>Device</th>
          <th>Visitor</th>
          <th>Session Started</th>
          <th>Last Activity</th>
          <th>Journey</th>
        </tr>
      </thead>
      <tbody>
        <% visitors.forEach(visitor => { %>
        <tr data-journey="<%= visitor.journey_id %>">
          <td>
            <% if (visitor.location && visitor.location.countryCode) { %>
              <span class="text-small"><%= visitor.location.city || visitor.location.country || visitor.location.countryCode %></span>
            <% } else { %>
              <span class="text-muted">Unknown</span>
            <% } %>
          </td>
          <td>
            <a href="<%= visitor.page_url %>" target="_blank" title="<%= visitor.page_url %>">
              <%= visitor.page_url ? visitor.page_url.replace(/^https?:\/\/[^\/]+/, '').substring(0, 40) : 'Unknown' %><%= visitor.page_url && visitor.page_url.replace(/^https?:\/\/[^\/]+/, '').length > 40 ? '...' : '' %>
            </a>
          </td>
          <td>
            <% if (visitor.referrer) { %>
            <span title="<%= visitor.referrer %>"><%= visitor.referrer.replace(/^https?:\/\/([^\/]+).*/, '$1').substring(0, 25) %></span>
            <% } else { %>
            <span class="text-muted">Direct</span>
            <% } %>
          </td>
          <td>
            <span class="badge badge-<%= visitor.device_type === 'mobile' ? 'warning' : visitor.device_type === 'tablet' ? 'info' : 'neutral' %>">
              <%= visitor.device_type || 'Unknown' %>
            </span>
          </td>
          <td>
            <% if (visitor.visit_number && visitor.visit_number > 1) { %>
              <span class="badge badge-gold">Return</span>
            <% } else { %>
              <span class="badge badge-neutral">New</span>
            <% } %>
          </td>
          <td><%= new Date(visitor.first_seen).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) %></td>
          <td class="last-activity"><%= new Date(visitor.last_activity).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) %></td>
          <td>
            <a href="/journeys/<%= visitor.journey_id %>" class="btn btn-outline btn-sm">View</a>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>
  </div>
  <% } %>
</div>

<style>
  #visitors-table tbody tr {
    transition: background-color 0.3s;
  }

  #visitors-table tbody tr.new-visitor {
    background: linear-gradient(90deg, rgba(16, 185, 129, 0.15) 0%, transparent 100%);
  }

  .visitor-count-change {
    animation: countPulse 0.5s ease-out;
  }

  @keyframes countPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.15); }
    100% { transform: scale(1); }
  }
</style>

<script>
  let pollInterval = null;
  let lastPollTime = Date.now();
  let previousJourneyIds = new Set(<%= JSON.stringify(visitors.map(v => v.journey_id)) %>);

  function formatTime(date) {
    return new Date(date).toLocaleTimeString('en-GB', {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
  }

  function truncateUrl(url, maxLength = 40) {
    if (!url) return 'Unknown';
    const path = url.replace(/^https?:\/\/[^\/]+/, '');
    return path.length > maxLength ? path.substring(0, maxLength) + '...' : path;
  }

  function truncateDomain(url, maxLength = 25) {
    if (!url) return '';
    const match = url.match(/^https?:\/\/([^\/]+)/);
    const domain = match ? match[1] : url;
    return domain.length > maxLength ? domain.substring(0, maxLength) + '...' : domain;
  }

  function updateLastUpdated() {
    const seconds = Math.round((Date.now() - lastPollTime) / 1000);
    const text = seconds < 5 ? 'Updated just now' : `Updated ${seconds}s ago`;
    document.getElementById('last-updated').textContent = text;
  }

  async function refreshData() {
    try {
      const response = await fetch('/realtime/api/visitors?seconds=60');
      const data = await response.json();

      if (!data.success) {
        console.error('Failed to fetch visitors:', data.error);
        return;
      }

      lastPollTime = Date.now();
      updateLastUpdated();

      // Update visitor count with animation
      const countEl = document.getElementById('visitor-count');
      const oldCount = parseInt(countEl.textContent);
      if (oldCount !== data.count) {
        countEl.textContent = data.count;
        countEl.classList.add('visitor-count-change');
        setTimeout(() => countEl.classList.remove('visitor-count-change'), 500);
      }

      // Calculate return rate
      const returnVisitors = data.visitors.filter(v => v.visit_number && v.visit_number > 1).length;
      const returnRate = data.visitors.length > 0 ? ((returnVisitors / data.visitors.length) * 100).toFixed(0) : 0;
      document.getElementById('return-rate').textContent = returnRate + '%';

      // Update locations
      const locationMap = {};
      data.visitors.forEach(v => {
        if (v.location && v.location.countryCode) {
          const code = v.location.countryCode;
          if (!locationMap[code]) {
            locationMap[code] = { country: v.location.country, count: 0 };
          }
          locationMap[code].count++;
        }
      });
      const locations = Object.values(locationMap).sort((a, b) => b.count - a.count);
      const uniqueCountries = locations.length;
      document.getElementById('locations-count').textContent = uniqueCountries;
      document.getElementById('locations-countries').textContent = locations.slice(0, 3).map(l => l.country).join(', ') || 'No data';

      // Update table
      const tbody = document.querySelector('#visitors-table tbody');

      if (data.visitors.length === 0) {
        if (tbody) {
          const tableContainer = document.querySelector('#visitors-table').closest('div[style*="overflow"]');
          if (tableContainer) {
            tableContainer.innerHTML = `
              <div class="empty-state">
                <h3>No active visitors</h3>
                <p>Visitors will appear here when they're browsing your website.</p>
              </div>
            `;
          }
        }
        previousJourneyIds.clear();
        return;
      }

      if (tbody) {
        const currentJourneyIds = new Set(data.visitors.map(v => v.journey_id));
        const newJourneyIds = new Set();

        currentJourneyIds.forEach(id => {
          if (!previousJourneyIds.has(id)) {
            newJourneyIds.add(id);
          }
        });

        tbody.innerHTML = data.visitors.map(v => {
          const isNew = newJourneyIds.has(v.journey_id);
          const deviceBadge = v.device_type === 'mobile' ? 'warning' : v.device_type === 'tablet' ? 'info' : 'neutral';
          const referrerHtml = v.referrer
            ? `<span title="${v.referrer}">${truncateDomain(v.referrer)}</span>`
            : '<span class="text-muted">Direct</span>';
          const locationHtml = v.location && v.location.countryCode
            ? `<span class="text-small">${v.location.city || v.location.country || v.location.countryCode}</span>`
            : '<span class="text-muted">Unknown</span>';
          const visitorBadge = v.visit_number && v.visit_number > 1
            ? '<span class="badge badge-gold">Return</span>'
            : '<span class="badge badge-neutral">New</span>';

          return `
            <tr data-journey="${v.journey_id}" class="${isNew ? 'new-visitor' : ''}">
              <td>${locationHtml}</td>
              <td><a href="${v.page_url}" target="_blank" title="${v.page_url}">${truncateUrl(v.page_url)}</a></td>
              <td>${referrerHtml}</td>
              <td><span class="badge badge-${deviceBadge}">${v.device_type || 'Unknown'}</span></td>
              <td>${visitorBadge}</td>
              <td>${formatTime(v.first_seen)}</td>
              <td class="last-activity">${formatTime(v.last_activity)}</td>
              <td><a href="/journeys/${v.journey_id}" class="btn btn-outline btn-sm">View</a></td>
            </tr>
          `;
        }).join('');

        setTimeout(() => {
          document.querySelectorAll('.new-visitor').forEach(el => {
            el.classList.remove('new-visitor');
          });
        }, 2000);

        previousJourneyIds = currentJourneyIds;
      }

      fetch('/realtime/api/new-journeys?seconds=60').catch(console.error);

    } catch (error) {
      console.error('Error refreshing data:', error);
    }
  }

  function startPolling() {
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(refreshData, 10000);
    setInterval(updateLastUpdated, 1000);
  }

  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
    } else {
      refreshData();
      startPolling();
    }
  });

  startPolling();
</script>
