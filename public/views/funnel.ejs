<div style="padding: 24px; max-width: 1400px; margin: 0 auto;">

  <!-- Header -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <div>
      <h2 style="margin: 0 0 4px; font-size: 1.5rem; font-weight: 700;">Conversion Funnel</h2>
      <p style="margin: 0; color: var(--text-secondary); font-size: 0.875rem;">
        Last <%= funnel.days %> days &mdash; step-by-step conversion tracking with period comparison
      </p>
    </div>
    <div style="display: flex; gap: 8px; align-items: center;">
      <a href="/funnel?days=7" class="btn-sm <%= funnel.days === 7 ? 'btn-primary' : 'btn-outline' %>" style="padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 0.8rem; border: 1px solid var(--border-color); color: <%= funnel.days === 7 ? '#fff' : 'var(--text-primary)' %>; background: <%= funnel.days === 7 ? 'var(--primary)' : 'transparent' %>;">7d</a>
      <a href="/funnel?days=14" class="btn-sm" style="padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 0.8rem; border: 1px solid var(--border-color); color: <%= funnel.days === 14 ? '#fff' : 'var(--text-primary)' %>; background: <%= funnel.days === 14 ? 'var(--primary)' : 'transparent' %>;">14d</a>
      <a href="/funnel?days=30" class="btn-sm" style="padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 0.8rem; border: 1px solid var(--border-color); color: <%= funnel.days === 30 ? '#fff' : 'var(--text-primary)' %>; background: <%= funnel.days === 30 ? 'var(--primary)' : 'transparent' %>;">30d</a>
      <a href="/funnel?days=90" class="btn-sm" style="padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 0.8rem; border: 1px solid var(--border-color); color: <%= funnel.days === 90 ? '#fff' : 'var(--text-primary)' %>; background: <%= funnel.days === 90 ? 'var(--primary)' : 'transparent' %>;">90d</a>
      <a href="/export/journeys?days=<%= funnel.days %>" style="padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 0.8rem; border: 1px solid #22c55e; color: #22c55e; background: transparent;">Export CSV</a>
    </div>
  </div>

  <!-- KPI Cards -->
  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
    <%
      const comp = funnel.comparison;
      const visitorChange = comp.prevTotal > 0 ? ((comp.currentTotal - comp.prevTotal) / comp.prevTotal * 100).toFixed(1) : 0;
      const convChange = comp.prevConversions > 0 ? ((comp.currentConversions - comp.prevConversions) / comp.prevConversions * 100).toFixed(1) : 0;
      const currentRate = comp.currentTotal > 0 ? (comp.currentConversions / comp.currentTotal * 100).toFixed(2) : 0;
      let biggestDrop = { name: 'N/A', pct: 0 };
      for (let i = 1; i < funnel.steps.length; i++) {
        const prev = funnel.steps[i-1].count;
        const curr = funnel.steps[i].count;
        const dropPct = prev > 0 ? ((prev - curr) / prev * 100) : 0;
        if (dropPct > biggestDrop.pct) {
          biggestDrop = { name: funnel.steps[i-1].name + ' > ' + funnel.steps[i].name, pct: dropPct };
        }
      }
    %>
    <div class="card" style="padding: 20px; text-align: center;">
      <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.5px; margin-bottom: 8px;">Visitors</div>
      <div style="font-size: 1.75rem; font-weight: 800;"><%= comp.currentTotal.toLocaleString() %></div>
      <div style="margin-top: 6px;">
        <span style="display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; background: <%= visitorChange >= 0 ? '#dcfce7' : '#fee2e2' %>; color: <%= visitorChange >= 0 ? '#16a34a' : '#dc2626' %>;">
          <%= visitorChange >= 0 ? '+' : '' %><%= visitorChange %>%
        </span>
        <span style="font-size: 0.7rem; color: var(--text-secondary);"> vs prev</span>
      </div>
    </div>

    <div class="card" style="padding: 20px; text-align: center;">
      <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.5px; margin-bottom: 8px;">Conversions</div>
      <div style="font-size: 1.75rem; font-weight: 800;"><%= comp.currentConversions %></div>
      <div style="margin-top: 6px;">
        <span style="display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; background: <%= convChange >= 0 ? '#dcfce7' : '#fee2e2' %>; color: <%= convChange >= 0 ? '#16a34a' : '#dc2626' %>;">
          <%= convChange >= 0 ? '+' : '' %><%= convChange %>%
        </span>
        <span style="font-size: 0.7rem; color: var(--text-secondary);"> vs prev</span>
      </div>
    </div>

    <div class="card" style="padding: 20px; text-align: center;">
      <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.5px; margin-bottom: 8px;">Conversion Rate</div>
      <div style="font-size: 1.75rem; font-weight: 800;"><%= currentRate %>%</div>
      <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 6px;">of visitors convert</div>
    </div>

    <div class="card" style="padding: 20px; text-align: center;">
      <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.5px; margin-bottom: 8px;">Biggest Drop-off</div>
      <div style="font-size: 1.75rem; font-weight: 800; color: #dc2626;"><%= biggestDrop.pct.toFixed(0) %>%</div>
      <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 6px;"><%= biggestDrop.name %></div>
    </div>
  </div>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">

    <!-- Funnel Visualisation -->
    <div class="card" style="padding: 24px;">
      <h3 style="margin: 0 0 20px; font-size: 1rem; font-weight: 600;">Visitor Journey Funnel</h3>
      <% const maxCount = funnel.steps[0].count || 1; %>
      <% const colours = ['#6366f1', '#8b5cf6', '#a78bfa', '#c084fc', '#22c55e']; %>
      <% funnel.steps.forEach(function(step, idx) { %>
        <% const widthPct = Math.max(20, (step.count / maxCount) * 100); %>
        <% const dropPct = idx > 0 && funnel.steps[idx-1].count > 0 ? ((funnel.steps[idx-1].count - step.count) / funnel.steps[idx-1].count * 100).toFixed(1) : null; %>
        <div style="display: flex; align-items: center; margin-bottom: 12px;">
          <div style="min-width: 100px; font-size: 0.8rem; font-weight: 600; color: var(--text-primary);"><%= step.name %></div>
          <div style="flex: 1; position: relative;">
            <div style="width: <%= widthPct %>%; background: <%= colours[idx] %>; padding: 10px 14px; border-radius: 6px; color: white; font-weight: 700; font-size: 0.85rem; min-height: 40px; display: flex; align-items: center; transition: width 0.5s ease;">
              <%= step.count.toLocaleString() %>
              <% if (idx > 0) { %>
                <span style="margin-left: 8px; font-size: 0.7rem; opacity: 0.85;">(<%= (step.count / maxCount * 100).toFixed(1) %>%)</span>
              <% } %>
            </div>
          </div>
          <% if (dropPct !== null) { %>
            <div style="min-width: 70px; text-align: right; color: #dc2626; font-size: 0.8rem; font-weight: 600;">-<%= dropPct %>%</div>
          <% } else { %>
            <div style="min-width: 70px;"></div>
          <% } %>
        </div>
      <% }); %>
    </div>

    <!-- Daily Trend Chart -->
    <div class="card" style="padding: 24px;">
      <h3 style="margin: 0 0 20px; font-size: 1rem; font-weight: 600;">Daily Visitors &amp; Conversions</h3>
      <canvas id="trendChart" height="250"></canvas>
    </div>
  </div>

  <!-- Page Drop-off Table -->
  <div class="card" style="padding: 24px;">
    <h3 style="margin: 0 0 16px; font-size: 1rem; font-weight: 600;">Entry Page Performance</h3>
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
        <thead>
          <tr style="border-bottom: 2px solid var(--border-color);">
            <th style="text-align: left; padding: 10px 8px; font-weight: 600;">Entry Page</th>
            <th style="text-align: right; padding: 10px 8px; font-weight: 600;">Visitors</th>
            <th style="text-align: right; padding: 10px 8px; font-weight: 600;">Conversions</th>
            <th style="text-align: right; padding: 10px 8px; font-weight: 600;">Conv. Rate</th>
            <th style="text-align: right; padding: 10px 8px; font-weight: 600;">Bounces</th>
            <th style="text-align: right; padding: 10px 8px; font-weight: 600;">Avg Events</th>
            <th style="text-align: right; padding: 10px 8px; font-weight: 600;">Confidence</th>
          </tr>
        </thead>
        <tbody>
          <% (funnel.pageDropoff || []).forEach(function(page) { %>
          <tr style="border-bottom: 1px solid var(--border-color);">
            <td style="padding: 10px 8px;">
              <span style="font-size: 0.8rem; word-break: break-all;"><%= typeof getPageName === 'function' ? getPageName(page.entry_page) : (page.entry_page || '').replace(/https?:\/\/[^\/]+/, '') || '/' %></span>
            </td>
            <td style="text-align: right; padding: 10px 8px; font-weight: 600;"><%= page.total_journeys %></td>
            <td style="text-align: right; padding: 10px 8px;">
              <span style="display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; background: #dcfce7; color: #16a34a;"><%= page.conversions %></span>
            </td>
            <td style="text-align: right; padding: 10px 8px;">
              <% const convRate = page.total_journeys > 0 ? (page.conversions / page.total_journeys * 100).toFixed(1) : 0; %>
              <span style="color: <%= convRate > 5 ? '#16a34a' : convRate > 0 ? '#ca8a04' : 'var(--text-secondary)' %>; font-weight: 600;">
                <%= convRate %>%
              </span>
            </td>
            <td style="text-align: right; padding: 10px 8px; color: #dc2626;"><%= page.bounces %></td>
            <td style="text-align: right; padding: 10px 8px;"><%= page.avg_events || '-' %></td>
            <td style="text-align: right; padding: 10px 8px;">
              <% const conf = page.avg_confidence || 0; %>
              <span style="display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 600;
                background: <%= conf >= 70 ? '#dcfce7' : conf >= 40 ? '#fef9c3' : '#f3f4f6' %>;
                color: <%= conf >= 70 ? '#16a34a' : conf >= 40 ? '#ca8a04' : '#6b7280' %>;">
                <%= conf %>
              </span>
            </td>
          </tr>
          <% }); %>
          <% if (!funnel.pageDropoff || funnel.pageDropoff.length === 0) { %>
          <tr>
            <td colspan="7" style="padding: 40px; text-align: center; color: var(--text-secondary);">
              No data available for this period. Check that tracking is active.
            </td>
          </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Daily Trend Chart Script -->
<script>
  const trendData = <%- JSON.stringify(funnel.dailyTrend || []) %>;

  if (trendData.length > 0) {
    const ctx = document.getElementById('trendChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: trendData.map(d => {
          const dt = new Date(d.date);
          return dt.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        }),
        datasets: [
          {
            label: 'Visitors',
            data: trendData.map(d => d.visitors),
            borderColor: '#6366f1',
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            fill: true,
            tension: 0.3,
            borderWidth: 2
          },
          {
            label: 'Conversions',
            data: trendData.map(d => d.conversions),
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            fill: true,
            tension: 0.3,
            borderWidth: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top', labels: { usePointStyle: true, boxWidth: 8 } }
        },
        scales: {
          x: { grid: { display: false } },
          y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }
        }
      }
    });
  }
</script>
