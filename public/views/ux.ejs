<style>
  .ux-kpi-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
  }

  @media (max-width: 1400px) {
    .ux-kpi-grid { grid-template-columns: repeat(3, 1fr); }
  }

  @media (max-width: 768px) {
    .ux-kpi-grid { grid-template-columns: repeat(2, 1fr); }
  }

  .ux-kpi-card {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 1.25rem;
    border: 1px solid var(--card-border);
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .ux-kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--border-grey);
  }

  .ux-kpi-card.good::before { background: var(--success); }
  .ux-kpi-card.warning::before { background: var(--warning); }
  .ux-kpi-card.bad::before { background: var(--danger); }
  .ux-kpi-card.info::before { background: var(--info); }

  .ux-kpi-card .label {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
  }

  .ux-kpi-card .value {
    font-size: 2rem;
    font-weight: 900;
    line-height: 1;
    margin-bottom: 0.25rem;
  }

  .ux-kpi-card.good .value { color: var(--success); }
  .ux-kpi-card.warning .value { color: var(--warning); }
  .ux-kpi-card.bad .value { color: var(--danger); }
  .ux-kpi-card.info .value { color: var(--info); }

  .ux-kpi-card .subtitle {
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .section-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  @media (max-width: 1024px) {
    .section-grid { grid-template-columns: 1fr; }
  }

  .insight-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 0.75rem;
    background: rgba(255, 159, 28, 0.1);
    border: 1px solid rgba(255, 159, 28, 0.3);
    border-radius: 8px;
    font-size: 0.75rem;
    color: var(--award-gold);
    margin-top: 0.75rem;
  }

  .truncate-text {
    max-width: 200px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .page-path {
    font-size: 0.75rem;
    color: var(--text-muted);
    max-width: 150px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .empty-section {
    padding: 2rem;
    text-align: center;
    color: var(--text-muted);
  }

  .empty-section .icon {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
    opacity: 0.5;
  }
</style>

<div class="flex justify-between items-center mb-4">
  <h2 style="font-size: 1.5rem;">UX Analytics</h2>
  <span class="text-small text-muted">Last 7 days (trends: 30 days)</span>
</div>

<!-- KPI Cards -->
<div class="ux-kpi-grid">
  <!-- Friction Score -->
  <div class="ux-kpi-card <%= overview.frictionScore <= 30 ? 'good' : overview.frictionScore <= 60 ? 'warning' : 'bad' %>">
    <div class="label">Friction Score</div>
    <div class="value"><%= overview.frictionScore %></div>
    <div class="subtitle"><%= overview.frictionScore <= 30 ? 'Good' : overview.frictionScore <= 60 ? 'Moderate' : 'High friction' %></div>
  </div>

  <!-- Dead Clicks -->
  <div class="ux-kpi-card <%= overview.deadClicks === 0 ? 'good' : overview.deadClicks <= 50 ? 'warning' : 'bad' %>">
    <div class="label">Dead Clicks</div>
    <div class="value"><%= overview.deadClicks %></div>
    <div class="subtitle">7-day total</div>
  </div>

  <!-- CTA Hesitation Rate -->
  <div class="ux-kpi-card <%= overview.hesitationRate <= 20 ? 'good' : overview.hesitationRate <= 40 ? 'warning' : 'bad' %>">
    <div class="label">CTA Hesitation</div>
    <div class="value"><%= overview.hesitationRate %>%</div>
    <div class="subtitle">Hover without click</div>
  </div>

  <!-- Quick Backs -->
  <div class="ux-kpi-card <%= overview.quickBacks === 0 ? 'good' : overview.quickBacks <= 20 ? 'warning' : 'bad' %>">
    <div class="label">Quick Backs</div>
    <div class="value"><%= overview.quickBacks %></div>
    <div class="subtitle">Back within 5s</div>
  </div>

  <!-- Scroll Behaviour -->
  <div class="ux-kpi-card <%= overview.scrollBehaviour === 'reading' ? 'good' : overview.scrollBehaviour === 'scanning' ? 'info' : 'warning' %>">
    <div class="label">Scroll Behaviour</div>
    <div class="value" style="font-size: 1.1rem; text-transform: capitalize;"><%= overview.scrollBehaviour %></div>
    <div class="subtitle">Dominant pattern</div>
  </div>

  <!-- Search Queries -->
  <div class="ux-kpi-card info">
    <div class="label">Site Searches</div>
    <div class="value"><%= overview.searches %></div>
    <div class="subtitle">7-day total</div>
  </div>
</div>

<!-- Friction Hotspots Section -->
<div class="section-grid">
  <!-- Dead Clicks Table -->
  <div class="card">
    <h2>Dead Click Hotspots</h2>
    <% if (deadClicks && deadClicks.length > 0) { %>
      <div class="insight-badge">
        These elements look clickable but aren't
      </div>
      <div style="overflow-x: auto; margin-top: 1rem;">
        <table>
          <thead>
            <tr>
              <th>Element</th>
              <th>Text</th>
              <th>Clicks</th>
              <th>Visitors</th>
            </tr>
          </thead>
          <tbody>
            <% deadClicks.slice(0, 10).forEach(item => { %>
              <tr>
                <td><code><%= item.element %></code></td>
                <td class="truncate-text" title="<%= item.text_clicked %>"><%= item.text_clicked || '-' %></td>
                <td><strong><%= item.click_count %></strong></td>
                <td><%= item.unique_visitors %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <div class="empty-section">
        <div class="icon">&#128077;</div>
        <p>No dead clicks detected</p>
      </div>
    <% } %>
  </div>

  <!-- CTA Hesitations Table -->
  <div class="card">
    <h2>CTA Hesitations</h2>
    <% if (hesitations && hesitations.length > 0) { %>
      <div class="insight-badge">
        Users are uncertain about these CTAs
      </div>
      <div style="overflow-x: auto; margin-top: 1rem;">
        <table>
          <thead>
            <tr>
              <th>CTA</th>
              <th>Avg Hover</th>
              <th>Hesitations</th>
              <th>Click Rate</th>
            </tr>
          </thead>
          <tbody>
            <% hesitations.slice(0, 10).forEach(item => { %>
              <tr>
                <td class="truncate-text" title="<%= item.cta_label %>"><%= item.cta_label %></td>
                <td><%= item.avg_hover_time %>s</td>
                <td><strong><%= item.hesitation_count %></strong></td>
                <td>
                  <span class="badge <%= item.click_rate >= 50 ? 'badge-success' : item.click_rate >= 25 ? 'badge-warning' : 'badge-danger' %>">
                    <%= item.click_rate %>%
                  </span>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <div class="empty-section">
        <div class="icon">&#128077;</div>
        <p>No CTA hesitations detected</p>
      </div>
    <% } %>
  </div>
</div>

<!-- Content Engagement Section -->
<div class="section-grid">
  <!-- Scroll Behaviour Chart -->
  <div class="card">
    <h2>Scroll Behaviour</h2>
    <% if (scrollBehaviour && scrollBehaviour.length > 0) { %>
      <div class="insight-badge">
        High skimming = content not engaging
      </div>
      <div class="chart-container small" style="margin-top: 1rem;">
        <canvas id="scrollChart"></canvas>
      </div>
    <% } else { %>
      <div class="empty-section">
        <div class="icon">&#128220;</div>
        <p>No scroll behaviour data yet</p>
      </div>
    <% } %>
  </div>

  <!-- Section Visibility -->
  <div class="card">
    <h2>Section View Times</h2>
    <% if (sectionVisibility && sectionVisibility.length > 0) { %>
      <div class="insight-badge">
        Which content gets attention vs skipped
      </div>
      <div class="chart-container small" style="margin-top: 1rem;">
        <canvas id="visibilityChart"></canvas>
      </div>
    <% } else { %>
      <div class="empty-section">
        <div class="icon">&#128065;</div>
        <p>No section visibility data yet</p>
      </div>
    <% } %>
  </div>
</div>

<!-- Navigation Issues Section -->
<div class="section-grid">
  <!-- Quick Backs Table -->
  <div class="card">
    <h2>Quick Back Analysis</h2>
    <% if (quickBacks && quickBacks.length > 0) { %>
      <div class="insight-badge">
        Page didn't match user expectations
      </div>
      <div style="overflow-x: auto; margin-top: 1rem;">
        <table>
          <thead>
            <tr>
              <th>Page</th>
              <th>Quick Backs</th>
              <th>Avg Time</th>
              <th>Visitors</th>
            </tr>
          </thead>
          <tbody>
            <% quickBacks.slice(0, 10).forEach(item => { %>
              <tr>
                <td class="page-path" title="<%= item.page_url %>"><%= item.page_url ? new URL(item.page_url).pathname : '-' %></td>
                <td><strong><%= item.quick_back_count %></strong></td>
                <td><%= item.avg_time_before_back || '-' %>s</td>
                <td><%= item.unique_visitors %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <div class="empty-section">
        <div class="icon">&#128077;</div>
        <p>No quick backs detected</p>
      </div>
    <% } %>
  </div>

  <!-- Search Queries Table -->
  <div class="card">
    <h2>Site Search Queries</h2>
    <% if (searches && searches.length > 0) { %>
      <div class="insight-badge">
        Content gaps - what should be more prominent
      </div>
      <div style="overflow-x: auto; margin-top: 1rem;">
        <table>
          <thead>
            <tr>
              <th>Query</th>
              <th>Searches</th>
              <th>Searchers</th>
            </tr>
          </thead>
          <tbody>
            <% searches.slice(0, 10).forEach(item => { %>
              <tr>
                <td class="truncate-text" title="<%= item.search_query %>"><%= item.search_query %></td>
                <td><strong><%= item.search_count %></strong></td>
                <td><%= item.unique_searchers %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <div class="empty-section">
        <div class="icon">&#128269;</div>
        <p>No site searches recorded</p>
      </div>
    <% } %>
  </div>
</div>

<!-- Text Selection Analysis -->
<div class="card">
  <h2>Text Selection Analysis</h2>
  <% if (selections && selections.length > 0) { %>
    <div class="insight-badge">
      High-value content or confusing content needing clarification
    </div>
    <div style="overflow-x: auto; margin-top: 1rem;">
      <table>
        <thead>
          <tr>
            <th>Selected Text</th>
            <th>Page</th>
            <th>Selections</th>
            <th>Users</th>
          </tr>
        </thead>
        <tbody>
          <% selections.slice(0, 15).forEach(item => { %>
            <tr>
              <td style="max-width: 400px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="<%= item.selected_text %>">
                "<%= item.selected_text %>"
              </td>
              <td class="page-path" title="<%= item.page_url %>"><%= item.page_url ? new URL(item.page_url).pathname : '-' %></td>
              <td><strong><%= item.selection_count %></strong></td>
              <td><%= item.unique_selectors %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } else { %>
    <div class="empty-section">
      <div class="icon">&#128221;</div>
      <p>No text selections recorded</p>
    </div>
  <% } %>
</div>

<!-- 30-Day Trend Chart -->
<div class="card">
  <h2>30-Day UX Trend</h2>
  <% if (trend && trend.length > 0) { %>
    <div class="insight-badge">
      Are UX changes improving metrics?
    </div>
    <div class="chart-container" style="margin-top: 1rem;">
      <canvas id="trendChart"></canvas>
    </div>
  <% } else { %>
    <div class="empty-section">
      <div class="icon">&#128200;</div>
      <p>Not enough data for trends yet</p>
    </div>
  <% } %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  const textColor = isDark ? '#ffffff' : '#2C3E50';
  const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.08)';

  // Scroll Behaviour Doughnut Chart
  <% if (scrollBehaviour && scrollBehaviour.length > 0) { %>
  const scrollData = <%- JSON.stringify(scrollBehaviour) %>;
  const scrollCtx = document.getElementById('scrollChart');
  if (scrollCtx) {
    new Chart(scrollCtx, {
      type: 'doughnut',
      data: {
        labels: scrollData.map(d => d.behaviour.charAt(0).toUpperCase() + d.behaviour.slice(1)),
        datasets: [{
          data: scrollData.map(d => parseInt(d.count)),
          backgroundColor: [
            '#10B981', // reading - green
            '#3B82F6', // scanning - blue
            '#F59E0B', // skimming - amber
            '#EF4444'  // rapid - red
          ],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: { color: textColor, padding: 15 }
          }
        }
      }
    });
  }
  <% } %>

  // Section Visibility Bar Chart
  <% if (sectionVisibility && sectionVisibility.length > 0) { %>
  const visibilityData = <%- JSON.stringify(sectionVisibility) %>;
  const visCtx = document.getElementById('visibilityChart');
  if (visCtx) {
    new Chart(visCtx, {
      type: 'bar',
      data: {
        labels: visibilityData.slice(0, 8).map(d => d.section.substring(0, 20)),
        datasets: [{
          label: 'Avg View Time (s)',
          data: visibilityData.slice(0, 8).map(d => parseFloat(d.avg_view_time)),
          backgroundColor: 'rgba(255, 159, 28, 0.7)',
          borderRadius: 4
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: {
            grid: { color: gridColor },
            ticks: { color: textColor }
          },
          y: {
            grid: { display: false },
            ticks: { color: textColor }
          }
        }
      }
    });
  }
  <% } %>

  // 30-Day Trend Line Chart
  <% if (trend && trend.length > 0) { %>
  const trendData = <%- JSON.stringify(trend) %>;
  const trendCtx = document.getElementById('trendChart');
  if (trendCtx) {
    new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: trendData.map(d => {
          const date = new Date(d.date);
          return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        }),
        datasets: [
          {
            label: 'Dead Clicks',
            data: trendData.map(d => parseInt(d.dead_clicks)),
            borderColor: '#EF4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.3,
            fill: false
          },
          {
            label: 'Quick Backs',
            data: trendData.map(d => parseInt(d.quick_backs)),
            borderColor: '#F59E0B',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            tension: 0.3,
            fill: false
          },
          {
            label: 'Hesitations',
            data: trendData.map(d => parseInt(d.hesitations)),
            borderColor: '#3B82F6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.3,
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            position: 'top',
            labels: { color: textColor, usePointStyle: true }
          }
        },
        scales: {
          x: {
            grid: { color: gridColor },
            ticks: { color: textColor, maxTicksLimit: 10 }
          },
          y: {
            grid: { color: gridColor },
            ticks: { color: textColor },
            beginAtZero: true
          }
        }
      }
    });
  }
  <% } %>
});
</script>
