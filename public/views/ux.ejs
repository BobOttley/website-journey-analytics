<style>
  .ux-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .ux-header h2 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
  }

  .ux-header .period {
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  /* KPI Grid */
  .ux-kpi-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
  }

  @media (max-width: 1400px) {
    .ux-kpi-grid { grid-template-columns: repeat(3, 1fr); }
  }

  @media (max-width: 768px) {
    .ux-kpi-grid { grid-template-columns: repeat(2, 1fr); }
  }

  .kpi-card {
    background: var(--bg-card);
    border-radius: 8px;
    padding: 1.25rem;
    border: 1px solid var(--card-border);
    text-align: center;
  }

  .kpi-card .label {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
  }

  .kpi-card .value {
    font-size: 1.75rem;
    font-weight: 700;
    line-height: 1.2;
    color: var(--text-primary);
  }

  .kpi-card .value.good { color: #10B981; }
  .kpi-card .value.warning { color: #F59E0B; }
  .kpi-card .value.bad { color: #EF4444; }
  .kpi-card .value.neutral { color: var(--text-primary); }

  .kpi-card .subtitle {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
  }

  /* Section Grid */
  .section-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  @media (max-width: 1024px) {
    .section-grid { grid-template-columns: 1fr; }
  }

  .section-card {
    background: var(--bg-card);
    border-radius: 8px;
    padding: 1.5rem;
    border: 1px solid var(--card-border);
  }

  .section-card h3 {
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-primary);
    margin: 0 0 1rem 0;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--card-border);
  }

  .section-card.full-width {
    grid-column: 1 / -1;
  }

  /* Tables */
  .data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }

  .data-table th {
    text-align: left;
    font-weight: 600;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    padding: 0.75rem 0.5rem;
    border-bottom: 1px solid var(--card-border);
  }

  .data-table td {
    padding: 0.75rem 0.5rem;
    border-bottom: 1px solid var(--card-border);
    color: var(--text-primary);
  }

  .data-table tr:last-child td {
    border-bottom: none;
  }

  .data-table .number {
    font-weight: 600;
    font-variant-numeric: tabular-nums;
  }

  .data-table .truncate {
    max-width: 180px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .data-table code {
    background: var(--bg-subtle);
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    font-size: 0.8rem;
  }

  /* Rate badge */
  .rate-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .rate-badge.low { background: rgba(16, 185, 129, 0.15); color: #10B981; }
  .rate-badge.medium { background: rgba(245, 158, 11, 0.15); color: #F59E0B; }
  .rate-badge.high { background: rgba(239, 68, 68, 0.15); color: #EF4444; }

  /* Empty state */
  .empty-state {
    padding: 2.5rem 1rem;
    text-align: center;
    color: var(--text-muted);
  }

  .empty-state .icon {
    width: 48px;
    height: 48px;
    margin: 0 auto 1rem;
    opacity: 0.4;
  }

  .empty-state p {
    font-size: 0.9rem;
    margin: 0;
  }

  /* Chart container */
  .chart-wrap {
    height: 220px;
    margin-top: 0.5rem;
  }

  .chart-wrap.tall {
    height: 300px;
  }
</style>

<div class="ux-header">
  <h2>UX Analytics</h2>
  <span class="period">Last 7 days</span>
</div>

<!-- KPI Cards -->
<div class="ux-kpi-grid">
  <div class="kpi-card">
    <div class="label">Friction Score</div>
    <div class="value <%= overview.frictionScore <= 20 ? 'good' : overview.frictionScore <= 50 ? 'warning' : 'bad' %>">
      <%= overview.frictionScore %>
    </div>
    <div class="subtitle"><%= overview.frictionScore <= 20 ? 'Low friction' : overview.frictionScore <= 50 ? 'Moderate' : 'High friction' %></div>
  </div>

  <div class="kpi-card">
    <div class="label">Dead Clicks</div>
    <div class="value <%= overview.deadClicks === 0 ? 'good' : overview.deadClicks <= 20 ? 'warning' : 'bad' %>">
      <%= overview.deadClicks %>
    </div>
    <div class="subtitle">7-day total</div>
  </div>

  <div class="kpi-card">
    <div class="label">CTA Hesitation</div>
    <div class="value <%= overview.hesitationRate <= 30 ? 'good' : overview.hesitationRate <= 60 ? 'warning' : 'bad' %>">
      <%= overview.hesitationRate %>%
    </div>
    <div class="subtitle">Hover without click</div>
  </div>

  <div class="kpi-card">
    <div class="label">Quick Backs</div>
    <div class="value <%= overview.quickBacks === 0 ? 'good' : overview.quickBacks <= 10 ? 'warning' : 'bad' %>">
      <%= overview.quickBacks %>
    </div>
    <div class="subtitle">Back within 5s</div>
  </div>

  <div class="kpi-card">
    <div class="label">Scroll Pattern</div>
    <div class="value neutral" style="font-size: 1.1rem; text-transform: capitalize;">
      <%= overview.scrollBehaviour || 'No data' %>
    </div>
    <div class="subtitle">Dominant behaviour</div>
  </div>

  <div class="kpi-card">
    <div class="label">Site Searches</div>
    <div class="value neutral"><%= overview.searches %></div>
    <div class="subtitle">7-day total</div>
  </div>
</div>

<!-- Dead Clicks (Full Width) -->
<div class="section-grid">
  <div class="section-card full-width">
    <h3>Dead Click Hotspots</h3>
    <% if (deadClicks && deadClicks.length > 0) { %>
      <p style="font-size: 0.85rem; color: var(--text-muted); margin: -0.5rem 0 1rem 0;">
        Visitors clicked these items expecting them to be interactive, but nothing happened. Consider making these clickable or changing their appearance.
      </p>
      <table class="data-table">
        <thead>
          <tr>
            <th style="width: 120px;">Type</th>
            <th>Text Clicked</th>
            <th style="width: 220px;">Page</th>
            <th style="width: 70px;">Clicks</th>
            <th style="width: 70px;">Users</th>
          </tr>
        </thead>
        <tbody>
          <%
            const elementNames = {
              'p': 'Paragraph',
              'span': 'Text',
              'div': 'Container',
              'h1': 'Main Heading',
              'h2': 'Heading',
              'h3': 'Subheading',
              'h4': 'Small Heading',
              'h5': 'Minor Heading',
              'h6': 'Minor Heading',
              'li': 'List Item',
              'ul': 'List',
              'ol': 'List',
              'td': 'Table Cell',
              'tr': 'Table Row',
              'th': 'Table Header',
              'img': 'Image',
              'section': 'Section',
              'article': 'Article',
              'nav': 'Navigation',
              'header': 'Header',
              'footer': 'Footer',
              'aside': 'Sidebar',
              'label': 'Label',
              'strong': 'Bold Text',
              'em': 'Italic Text',
              'b': 'Bold Text',
              'i': 'Icon/Italic'
            };

            // Convert page paths to friendly names
            function getPageName(url) {
              if (!url) return '-';
              try {
                const pathname = new URL(url).pathname;
                // Remove leading slash and .html extension
                let name = pathname.replace(/^\//, '').replace(/\.html?$/, '');
                // Handle index
                if (name === '' || name === 'index') return 'Home';
                // Capitalise first letter and replace hyphens with spaces
                name = name.split('/').pop(); // Get last segment
                name = name.replace(/-/g, ' ');
                return name.charAt(0).toUpperCase() + name.slice(1);
              } catch(e) {
                return url;
              }
            }
          %>
          <% deadClicks.slice(0, 10).forEach(item => {
            const friendlyType = elementNames[item.element] || item.element;
            const pageName = getPageName(item.page_url);
          %>
            <tr>
              <td><%= friendlyType %></td>
              <td title="<%= item.text_clicked %>" style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                "<%= item.text_clicked || '-' %>"
              </td>
              <td title="<%= item.page_url %>" style="font-size: 0.85rem;">
                <%= pageName %>
              </td>
              <td class="number"><%= item.click_count %></td>
              <td class="number"><%= item.unique_visitors %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } else { %>
      <div class="empty-state">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <p>No dead clicks detected - visitors aren't clicking on non-interactive elements</p>
      </div>
    <% } %>
  </div>
</div>

<!-- CTA Hesitations + Scroll Behaviour -->
<div class="section-grid">
  <div class="section-card">
    <h3>CTA Hesitations</h3>
    <% if (hesitations && hesitations.length > 0) { %>
      <p style="font-size: 0.85rem; color: var(--text-muted); margin: -0.5rem 0 1rem 0;">
        Visitors hovered over these buttons but didn't click. Low click rates suggest uncertainty or unclear value.
      </p>
      <table class="data-table">
        <thead>
          <tr>
            <th>Button Text</th>
            <th>Hover Time</th>
            <th>Times</th>
            <th>Clicked</th>
          </tr>
        </thead>
        <tbody>
          <% hesitations.slice(0, 8).forEach(item => { %>
            <tr>
              <td title="<%= item.cta_label %>" style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                <%= item.cta_label %>
              </td>
              <td><%= item.avg_hover_time %>s</td>
              <td class="number"><%= item.hesitation_count %></td>
              <td>
                <span class="rate-badge <%= item.click_rate >= 50 ? 'low' : item.click_rate >= 25 ? 'medium' : 'high' %>">
                  <%= item.click_rate %>%
                </span>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } else { %>
      <div class="empty-state">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <p>No hesitations detected - visitors are clicking buttons confidently</p>
      </div>
    <% } %>
  </div>

  <div class="section-card">
    <h3>Scroll Behaviour</h3>
    <% if (scrollBehaviour && scrollBehaviour.length > 0) { %>
      <p style="font-size: 0.85rem; color: var(--text-muted); margin: -0.5rem 0 1rem 0;">
        How visitors scroll: Reading (slow, engaged), Scanning (medium, looking for something), Skimming (fast, not reading).
      </p>
      <div class="chart-wrap">
        <canvas id="scrollChart"></canvas>
      </div>
    <% } else { %>
      <div class="empty-state">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
        </svg>
        <p>No scroll data yet</p>
      </div>
    <% } %>
  </div>
</div>

<!-- Section View Times + Quick Backs -->
<div class="section-grid">
  <div class="section-card">
    <h3>Section View Times</h3>
    <% if (sectionVisibility && sectionVisibility.length > 0) { %>
      <p style="font-size: 0.85rem; color: var(--text-muted); margin: -0.5rem 0 1rem 0;">
        Which sections get the most attention. Longer times = more engagement.
      </p>
      <div class="chart-wrap">
        <canvas id="visibilityChart"></canvas>
      </div>
    <% } else { %>
      <div class="empty-state">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
        </svg>
        <p>No visibility data yet</p>
      </div>
    <% } %>
  </div>

  <div class="section-card">
    <h3>Quick Back Analysis</h3>
    <% if (quickBacks && quickBacks.length > 0) { %>
      <p style="font-size: 0.85rem; color: var(--text-muted); margin: -0.5rem 0 1rem 0;">
        Pages where visitors hit the back button within 5 seconds. Content didn't match expectations.
      </p>
      <table class="data-table">
        <thead>
          <tr>
            <th>Page</th>
            <th>Backs</th>
            <th>Avg Time</th>
            <th>Users</th>
          </tr>
        </thead>
        <tbody>
          <% quickBacks.slice(0, 6).forEach(item => { %>
            <tr>
              <td class="truncate" title="<%= item.page_url %>">
                <%= item.page_url ? new URL(item.page_url).pathname : '-' %>
              </td>
              <td class="number"><%= item.quick_back_count %></td>
              <td><%= item.avg_time_before_back || '-' %>s</td>
              <td class="number"><%= item.unique_visitors %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } else { %>
      <div class="empty-state">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <p>No quick backs detected - pages match visitor expectations</p>
      </div>
    <% } %>
  </div>
</div>

<!-- Site Searches + Text Selections (only show if there's data) -->
<% if ((searches && searches.length > 0) || (selections && selections.length > 0)) { %>
<div class="section-grid">
  <% if (searches && searches.length > 0) { %>
  <div class="section-card">
    <h3>Site Search Queries</h3>
    <p style="font-size: 0.85rem; color: var(--text-muted); margin: -0.5rem 0 1rem 0;">
      What visitors searched for. These are content gaps - make this info more visible.
    </p>
    <table class="data-table">
      <thead>
        <tr>
          <th>Query</th>
          <th>Times</th>
          <th>Users</th>
        </tr>
      </thead>
      <tbody>
        <% searches.slice(0, 8).forEach(item => { %>
          <tr>
            <td class="truncate" title="<%= item.search_query %>"><%= item.search_query %></td>
            <td class="number"><%= item.search_count %></td>
            <td class="number"><%= item.unique_searchers %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
  <% } %>

  <% if (selections && selections.length > 0) { %>
  <div class="section-card">
    <h3>Text Selection Analysis</h3>
    <p style="font-size: 0.85rem; color: var(--text-muted); margin: -0.5rem 0 1rem 0;">
      Text visitors copied or highlighted. Could be valuable info or confusing content.
    </p>
    <table class="data-table">
      <thead>
        <tr>
          <th>Text</th>
          <th>Times</th>
          <th>Users</th>
        </tr>
      </thead>
      <tbody>
        <% selections.slice(0, 6).forEach(item => { %>
          <tr>
            <td class="truncate" style="max-width: 200px;" title="<%= item.selected_text %>">
              "<%= item.selected_text %>"
            </td>
            <td class="number"><%= item.selection_count %></td>
            <td class="number"><%= item.unique_selectors %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
  <% } %>
</div>
<% } %>

<!-- 30-Day Trend (full width) - only show if we have at least 3 days of data -->
<% if (trend && trend.length >= 3) { %>
<div class="section-grid">
  <div class="section-card full-width">
    <h3>30-Day UX Trend</h3>
    <p style="font-size: 0.85rem; color: var(--text-muted); margin: -0.5rem 0 1rem 0;">
      Track friction metrics over time. Decreasing trends = UX improvements working.
    </p>
    <div class="chart-wrap tall">
      <canvas id="trendChart"></canvas>
    </div>
  </div>
</div>
<% } %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  const textColor = isDark ? '#94a3b8' : '#64748b';
  const gridColor = isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)';

  // Scroll Behaviour Doughnut
  <% if (scrollBehaviour && scrollBehaviour.length > 0) { %>
  const scrollData = <%- JSON.stringify(scrollBehaviour) %>;
  const scrollCtx = document.getElementById('scrollChart');
  if (scrollCtx) {
    new Chart(scrollCtx, {
      type: 'doughnut',
      data: {
        labels: scrollData.map(d => d.behaviour.charAt(0).toUpperCase() + d.behaviour.slice(1)),
        datasets: [{
          data: scrollData.map(d => parseInt(d.count)),
          backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#EF4444'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%',
        plugins: {
          legend: {
            position: 'right',
            labels: { color: textColor, padding: 12, usePointStyle: true, pointStyle: 'circle' }
          }
        }
      }
    });
  }
  <% } %>

  // Section Visibility Bar
  <% if (sectionVisibility && sectionVisibility.length > 0) { %>
  const visibilityData = <%- JSON.stringify(sectionVisibility) %>;
  const visCtx = document.getElementById('visibilityChart');
  if (visCtx) {
    // Helper to get friendly page name from URL
    function getPageName(url) {
      if (!url) return '';
      try {
        const pathname = new URL(url).pathname;
        let name = pathname.replace(/^\//, '').replace(/\.html?$/, '');
        if (name === '' || name === 'index') return 'Home';
        name = name.split('/').pop();
        name = name.replace(/-/g, ' ');
        return name.charAt(0).toUpperCase() + name.slice(1);
      } catch(e) { return ''; }
    }

    // Helper to format section name
    function formatSection(section) {
      return section.replace(/-/g, ' ').replace(/section$/i, '').trim()
        .split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    }

    new Chart(visCtx, {
      type: 'bar',
      data: {
        labels: visibilityData.slice(0, 6).map(d => {
          const page = getPageName(d.page_url);
          const section = formatSection(d.section);
          return page ? `${page}: ${section}` : section;
        }),
        datasets: [{
          label: 'Avg View Time (s)',
          data: visibilityData.slice(0, 6).map(d => parseFloat(d.avg_view_time)),
          backgroundColor: '#3B82F6',
          borderRadius: 4
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { color: gridColor }, ticks: { color: textColor } },
          y: { grid: { display: false }, ticks: { color: textColor, font: { size: 11 } } }
        }
      }
    });
  }
  <% } %>

  // 30-Day Trend Line (only show if we have at least 3 days of data)
  <% if (trend && trend.length >= 3) { %>
  const trendData = <%- JSON.stringify(trend) %>;
  const trendCtx = document.getElementById('trendChart');
  if (trendCtx) {
    new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: trendData.map(d => {
          const date = new Date(d.date);
          return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        }),
        datasets: [
          {
            label: 'Dead Clicks',
            data: trendData.map(d => parseInt(d.dead_clicks)),
            borderColor: '#EF4444',
            backgroundColor: 'transparent',
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 4
          },
          {
            label: 'Quick Backs',
            data: trendData.map(d => parseInt(d.quick_backs)),
            borderColor: '#F59E0B',
            backgroundColor: 'transparent',
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 4
          },
          {
            label: 'Hesitations',
            data: trendData.map(d => parseInt(d.hesitations)),
            borderColor: '#3B82F6',
            backgroundColor: 'transparent',
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: {
            position: 'top',
            labels: { color: textColor, usePointStyle: true, pointStyle: 'line', padding: 20 }
          }
        },
        scales: {
          x: { grid: { color: gridColor }, ticks: { color: textColor, maxTicksLimit: 8 } },
          y: { grid: { color: gridColor }, ticks: { color: textColor }, beginAtZero: true }
        }
      }
    });
  }
  <% } %>
});
</script>
