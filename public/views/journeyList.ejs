<% if (typeof rebuilt !== 'undefined') { %>
<div class="alert alert-success slide-in">
  Successfully rebuilt <%= rebuilt %> journeys from events.
</div>
<% } %>

<!-- Hero KPI Cards - Human Visitors Only -->
<div class="stats-grid">
  <div class="stat-card highlight">
    <h3>Human Visitors</h3>
    <div class="value"><%= stats.human_visitors || 0 %></div>
    <div class="subtitle">Unique people tracked</div>
  </div>
  <div class="stat-card" style="border-top-color: #8b5cf6;">
    <h3>Return Visitors</h3>
    <div class="value" style="color: #8b5cf6;"><%= stats.return_visitors || 0 %></div>
    <div class="subtitle">
      <% const humanCount = parseInt(stats.human_visitors) || 0; %>
      <% const returnCount = parseInt(stats.return_visitors) || 0; %>
      <% if (humanCount > 0) { %>
        <%= ((returnCount / humanCount) * 100).toFixed(0) %>% came back
      <% } else { %>
        No data yet
      <% } %>
    </div>
  </div>
  <div class="stat-card success">
    <h3>Enquiries</h3>
    <div class="value"><%= stats.enquiries || 0 %></div>
    <div class="subtitle">
      <% if (humanCount > 0) { %>
        <%= ((parseInt(stats.enquiries) / humanCount) * 100).toFixed(1) %>% conversion
      <% } else { %>
        No data yet
      <% } %>
    </div>
  </div>
  <div class="stat-card info">
    <h3>Visits Booked</h3>
    <div class="value"><%= stats.visits_booked || 0 %></div>
    <div class="subtitle">
      <% if (humanCount > 0) { %>
        <%= ((parseInt(stats.visits_booked) / humanCount) * 100).toFixed(1) %>% booking rate
      <% } else { %>
        No data yet
      <% } %>
    </div>
  </div>
</div>

<!-- Bots Detected Card (small, separate) -->
<% const botCount = parseInt(stats.bot_count) || 0; %>
<% if (botCount > 0) { %>
<div class="card mb-4" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); padding: 1rem;">
  <div class="flex justify-between items-center">
    <div>
      <span style="color: #f87171; font-weight: 600;">Bots Filtered Out:</span>
      <span style="color: #ef4444; font-weight: 700; margin-left: 8px;"><%= botCount %></span>
      <span style="color: #94a3b8; font-size: 0.8rem; margin-left: 8px;">
        (Google crawlers, SEO tools, etc.)
      </span>
    </div>
    <a href="/bots" class="btn btn-sm" style="background: rgba(239, 68, 68, 0.2); color: #f87171; border: none;">View Bots</a>
  </div>
</div>
<% } %>

<!-- Traffic Quality (Bot Detection) -->
<%
  const totalVisitors = stats.human_visitors + stats.bot_count;
  const humanPercent = totalVisitors > 0 ? Math.round((stats.human_visitors / totalVisitors) * 100) : 0;
  const botPercent = totalVisitors > 0 ? Math.round((stats.bot_count / totalVisitors) * 100) : 0;
%>
<% if (totalVisitors > 0) { %>
<div class="card mb-6" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid rgba(255,255,255,0.1);">
  <div class="flex justify-between items-center mb-4">
    <h2 style="margin-bottom: 0; display: flex; align-items: center; gap: 8px;">
      <span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; display: inline-block;"></span>
      Traffic Quality
      <span style="font-size: 0.75rem; font-weight: normal; color: #94a3b8;">(Bot Detection)</span>
    </h2>
    <form action="/journeys/rebuild" method="POST" style="margin: 0;">
      <button type="submit" class="btn btn-sm" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: none; font-size: 0.75rem;">
        Recalculate
      </button>
    </form>
  </div>

  <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
    <!-- Total Visitors -->
    <div class="stat-card" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3);">
      <h3 style="font-size: 0.8rem; color: #60a5fa;">Total Visitors</h3>
      <div class="value" style="color: #3b82f6;"><%= totalVisitors %></div>
      <div class="subtitle" style="font-size: 0.7rem;">
        All tracked sessions
      </div>
    </div>

    <!-- Humans -->
    <div class="stat-card" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);">
      <h3 style="font-size: 0.8rem; color: #34d399;">Real Humans</h3>
      <div class="value" style="color: #10b981;"><%= stats.human_visitors %></div>
      <div class="subtitle" style="font-size: 0.7rem;">
        Quality visitors
      </div>
    </div>

    <!-- Quality Score -->
    <div class="stat-card" style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3);">
      <h3 style="font-size: 0.8rem; color: #a78bfa;">Quality Score</h3>
      <div class="value" style="color: #8b5cf6;"><%= humanPercent %>%</div>
      <div class="subtitle" style="font-size: 0.7rem;">
        Human visitor rate
      </div>
    </div>

    <!-- Bots Detected -->
    <div class="stat-card" style="background: rgba(249, 115, 22, 0.1); border: 1px solid rgba(249, 115, 22, 0.3);">
      <h3 style="font-size: 0.8rem; color: #fb923c;">Bots Detected</h3>
      <div class="value" style="color: #f97316;"><%= stats.bot_count %></div>
      <div class="subtitle" style="font-size: 0.7rem;">
        <%= botPercent %>% of traffic
      </div>
    </div>
  </div>
</div>
<% } else { %>
<!-- Pixel Tracking Setup Prompt -->
<div class="card mb-6" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px dashed rgba(255,255,255,0.2);">
  <h2 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 8px;">
    <span style="width: 8px; height: 8px; background: #f59e0b; border-radius: 50%; display: inline-block;"></span>
    Enable Pixel Tracking
  </h2>
  <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 1rem;">
    Add pixel tracking to capture visitors that JavaScript misses (bots, ad-blockers, fast bounces).
  </p>
  <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.8rem; color: #e2e8f0; overflow-x: auto;">
    &lt;img src="https://website-journey-analytics.onrender.com/p.gif?k=YOUR_TRACKING_KEY" style="position:absolute;width:1px;height:1px;opacity:0" /&gt;
  </div>
  <p style="color: #64748b; font-size: 0.75rem; margin-top: 0.5rem;">
    Add this to your website's HTML just before &lt;/body&gt;
  </p>
</div>
<% } %>

<!-- Charts Section -->
<div class="grid-2 mb-6">
  <!-- Conversion Funnel -->
  <div class="card">
    <h2>Conversion Funnel</h2>
    <div class="chart-container">
      <canvas id="funnelChart"></canvas>
    </div>
  </div>

  <!-- Top Pages -->
  <div class="card">
    <h2>Page Popularity</h2>
    <div class="chart-container">
      <canvas id="pagesChart"></canvas>
    </div>
  </div>
</div>

<div class="grid-2 mb-6">
  <!-- Device Breakdown -->
  <div class="card">
    <h2>Device Breakdown</h2>
    <div class="chart-container small" style="max-width: 300px; margin: 0 auto;">
      <canvas id="deviceChart"></canvas>
    </div>
  </div>

  <!-- Traffic Sources -->
  <div class="card">
    <h2>Traffic Sources</h2>
    <div class="chart-container small" style="max-width: 300px; margin: 0 auto;">
      <canvas id="sourcesChart"></canvas>
    </div>
  </div>
</div>

<!-- Daily Trend -->
<div class="card mb-6">
  <h2>Journey Trend (Last 30 Days)</h2>
  <div class="chart-container">
    <canvas id="trendChart"></canvas>
  </div>
</div>

<!-- Journey Table -->
<div class="card">
  <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
    <h2 style="margin-bottom: 0;">All Journeys</h2>
    <div class="flex items-center gap-2">
      <!-- Bot Filter Buttons -->
      <div class="filter-buttons" style="display: flex; gap: 4px; margin-right: 1rem;">
        <a href="/journeys?filter=all" class="btn btn-sm <%= (typeof filter === 'undefined' || filter === 'all') ? 'btn-primary' : 'btn-secondary' %>">All</a>
        <a href="/journeys?filter=humans" class="btn btn-sm <%= filter === 'humans' ? 'btn-primary' : 'btn-secondary' %>">Humans Only</a>
        <a href="/journeys?filter=bots" class="btn btn-sm <%= filter === 'bots' ? 'btn-primary' : 'btn-secondary' %>">Bots Only</a>
      </div>
      <form action="/journeys/rebuild" method="POST" style="display: inline;">
        <button type="submit" class="btn btn-secondary btn-sm">Rebuild Journeys</button>
      </form>
    </div>
  </div>

  <% if (journeys.length === 0) { %>
    <div class="empty-state">
      <h3>No journeys recorded yet</h3>
      <p>Events will appear here once the tracking script captures visitor behaviour.</p>
    </div>
  <% } else { %>
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>Visitor</th>
            <th>First Seen</th>
            <th>Entry Page</th>
            <th>Pages</th>
            <th>Events</th>
            <th>Status</th>
            <th>Outcome</th>
            <th>Time to Action</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% journeys.forEach(journey => { %>
            <%
              // Mask IP for privacy (show first two octets)
              const ip = journey.primary_ip_address;
              const maskedIP = ip ? ip.split('.').slice(0, 2).join('.') + '.x.x' : null;
            %>
            <tr>
              <td>
                <div class="visitor-cell">
                  <% if (maskedIP) { %>
                    <span class="ip-masked" title="Masked IP address"><%= maskedIP %></span>
                  <% } else { %>
                    <span class="text-muted">Unknown</span>
                  <% } %>
                  <% if (journey.is_bot) { %>
                    <span class="badge badge-danger" style="margin-left: 4px; font-size: 0.6rem;" title="Bot score: <%= journey.bot_score || 0 %>">BOT</span>
                  <% } %>
                </div>
              </td>
              <td class="text-small"><%= new Date(journey.first_seen).toLocaleString('en-GB', { dateStyle: 'short', timeStyle: 'short' }) %></td>
              <td class="text-small entry-page-cell" data-url="<%= journey.entry_page || '' %>">
                <% if (journey.entry_page) { %>
                  <span class="entry-page-name"></span>
                <% } else { %>
                  <span class="text-muted">-</span>
                <% } %>
              </td>
              <td><%= journey.page_sequence?.length || 0 %></td>
              <td><%= journey.event_count %></td>
              <td>
                <% if (journey.visit_number && journey.visit_number > 1) { %>
                  <span class="badge badge-gold" title="Visit #<%= journey.visit_number %>">Return</span>
                <% } else { %>
                  <span class="badge badge-neutral">New</span>
                <% } %>
              </td>
              <td>
                <% if (journey.outcome === 'enquiry_submitted') { %>
                  <span class="badge badge-success">Enquiry</span>
                <% } else if (journey.outcome === 'visit_booked') { %>
                  <span class="badge badge-success">Visit Booked</span>
                <% } else if (journey.outcome === 'engaged') { %>
                  <span class="badge badge-info">Engaged</span>
                <% } else if (journey.outcome === 'form_abandoned') { %>
                  <span class="badge badge-warning">Form Abandoned</span>
                <% } else { %>
                  <span class="badge badge-neutral">No Action</span>
                <% } %>
              </td>
              <td>
                <% if (journey.time_to_action) { %>
                  <span class="text-small">
                    <%= Math.floor(journey.time_to_action / 60) %>m <%= journey.time_to_action % 60 %>s
                  </span>
                <% } else { %>
                  <span class="text-muted">-</span>
                <% } %>
              </td>
              <td>
                <a href="/journeys/<%= journey.journey_id %>" class="btn btn-outline btn-sm">View</a>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <% if (pagination.totalPages > 1) { %>
      <%
        const filterParam = filter && filter !== 'all' ? `&filter=${filter}` : '';
      %>
      <div class="pagination">
        <% if (pagination.hasPrev) { %>
          <a href="/journeys?page=<%= pagination.page - 1 %><%= filterParam %>">Previous</a>
        <% } %>

        <%
          let startPage = Math.max(1, pagination.page - 2);
          let endPage = Math.min(pagination.totalPages, pagination.page + 2);
        %>

        <% if (startPage > 1) { %>
          <a href="/journeys?page=1<%= filterParam %>">1</a>
          <% if (startPage > 2) { %><span style="padding: 10px;">...</span><% } %>
        <% } %>

        <% for (let i = startPage; i <= endPage; i++) { %>
          <a href="/journeys?page=<%= i %><%= filterParam %>" class="<%= i === pagination.page ? 'active' : '' %>"><%= i %></a>
        <% } %>

        <% if (endPage < pagination.totalPages) { %>
          <% if (endPage < pagination.totalPages - 1) { %><span style="padding: 10px;">...</span><% } %>
          <a href="/journeys?page=<%= pagination.totalPages %><%= filterParam %>"><%= pagination.totalPages %></a>
        <% } %>

        <% if (pagination.hasNext) { %>
          <a href="/journeys?page=<%= pagination.page + 1 %><%= filterParam %>">Next</a>
        <% } %>
      </div>
    <% } %>
  <% } %>
</div>

<script>
  function getChartColors() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    return {
      text: isDark ? '#ffffff' : '#2C3E50',
      grid: isDark ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.08)'
    };
  }

  const brandColors = {
    gold: '#FF9F1C',
    goldLight: '#FFB84D',
    navy: '#091825',
    blue: '#034674',
    success: '#10B981',
    warning: '#F59E0B',
    danger: '#EF4444',
    info: '#3B82F6'
  };

  async function loadCharts() {
    try {
      const response = await fetch('/journeys/api/charts');
      const result = await response.json();

      if (!result.success) {
        console.error('Failed to load chart data');
        return;
      }

      const data = result.data;
      const colors = getChartColors();

      // Conversion Funnel
      if (data.conversionFunnel && data.conversionFunnel.length > 0) {
        const funnelCtx = document.getElementById('funnelChart').getContext('2d');
        new Chart(funnelCtx, {
          type: 'bar',
          data: {
            labels: data.conversionFunnel.map(f => f.stage),
            datasets: [{
              data: data.conversionFunnel.map(f => f.count),
              backgroundColor: [
                brandColors.blue,
                brandColors.info,
                brandColors.gold,
                brandColors.warning,
                brandColors.success
              ],
              borderRadius: 6,
              barThickness: 30
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { color: colors.grid }, ticks: { color: colors.text } },
              y: { grid: { display: false }, ticks: { color: colors.text, font: { weight: 600 } } }
            }
          }
        });
      }

      // Top Pages - with friendly names
      if (data.topPages && data.topPages.length > 0) {
        const pagesCtx = document.getElementById('pagesChart').getContext('2d');
        const pageLabels = data.topPages.map(p => getPageName(p.page_url));

        new Chart(pagesCtx, {
          type: 'bar',
          data: {
            labels: pageLabels,
            datasets: [{
              label: 'Views',
              data: data.topPages.map(p => parseInt(p.views)),
              backgroundColor: brandColors.gold,
              borderRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { display: false }, ticks: { color: colors.text, maxRotation: 45, font: { weight: 600 } } },
              y: { grid: { color: colors.grid }, ticks: { color: colors.text } }
            }
          }
        });
      }

      // Device Breakdown
      if (data.deviceBreakdown && data.deviceBreakdown.length > 0) {
        const deviceCtx = document.getElementById('deviceChart').getContext('2d');
        const deviceColors = { 'desktop': brandColors.blue, 'mobile': brandColors.gold, 'tablet': brandColors.success, 'unknown': '#94a3b8' };

        new Chart(deviceCtx, {
          type: 'doughnut',
          data: {
            labels: data.deviceBreakdown.map(d => d.device_type.charAt(0).toUpperCase() + d.device_type.slice(1)),
            datasets: [{
              data: data.deviceBreakdown.map(d => parseInt(d.count)),
              backgroundColor: data.deviceBreakdown.map(d => deviceColors[d.device_type] || '#94a3b8'),
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: { legend: { position: 'bottom', labels: { color: colors.text, padding: 16, usePointStyle: true } } }
          }
        });
      }

      // Traffic Sources
      if (data.trafficSources && data.trafficSources.length > 0) {
        const sourcesCtx = document.getElementById('sourcesChart').getContext('2d');
        const sourceColors = [brandColors.gold, brandColors.blue, brandColors.success, brandColors.warning, brandColors.info, '#8B5CF6', '#EC4899', '#94a3b8'];

        new Chart(sourcesCtx, {
          type: 'doughnut',
          data: {
            labels: data.trafficSources.map(s => s.source),
            datasets: [{
              data: data.trafficSources.map(s => parseInt(s.count)),
              backgroundColor: sourceColors.slice(0, data.trafficSources.length),
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: { legend: { position: 'bottom', labels: { color: colors.text, padding: 16, usePointStyle: true } } }
          }
        });
      }

      // Daily Trend
      if (data.dailyTrend && data.dailyTrend.length > 0) {
        const trendCtx = document.getElementById('trendChart').getContext('2d');

        new Chart(trendCtx, {
          type: 'line',
          data: {
            labels: data.dailyTrend.map(d => {
              const date = new Date(d.date);
              return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            }),
            datasets: [
              {
                label: 'Journeys',
                data: data.dailyTrend.map(d => parseInt(d.journeys)),
                borderColor: brandColors.blue,
                backgroundColor: 'rgba(3, 70, 116, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: brandColors.blue
              },
              {
                label: 'Conversions',
                data: data.dailyTrend.map(d => parseInt(d.conversions)),
                borderColor: brandColors.success,
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: brandColors.success
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: { legend: { position: 'top', labels: { color: colors.text, usePointStyle: true, padding: 20 } } },
            scales: {
              x: { grid: { color: colors.grid }, ticks: { color: colors.text } },
              y: { grid: { color: colors.grid }, ticks: { color: colors.text }, beginAtZero: true }
            }
          }
        });
      }

    } catch (error) {
      console.error('Error loading charts:', error);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadCharts();

    // Populate friendly page names in table
    document.querySelectorAll('.entry-page-cell').forEach(cell => {
      const url = cell.dataset.url;
      const nameEl = cell.querySelector('.entry-page-name');
      if (url && nameEl) {
        const icon = getPageIcon(url);
        const name = getPageName(url);
        nameEl.innerHTML = `<span style="margin-right: 6px;">${icon}</span>${name}`;
        nameEl.title = url;
      }
    });
  });
</script>

<style>
  .visitor-cell {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .ip-masked {
    font-family: monospace;
    font-size: 0.85rem;
    color: var(--text-primary);
  }
</style>
