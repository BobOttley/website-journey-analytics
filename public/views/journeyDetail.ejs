<div class="flex justify-between items-center mb-4">
  <div>
    <a href="/journeys" class="text-muted text-small">← Back to Journeys</a>
    <h2 class="mt-4" style="font-size: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
      Journey <span class="journey-id">#<%= journey.journey_id.substring(4, 16) %></span>
    </h2>
  </div>
  <div class="flex gap-2 items-center">
    <% if (journey.visit_number && journey.visit_number > 1) { %>
      <span class="badge badge-gold">Return Visitor (Visit #<%= journey.visit_number %>)</span>
    <% } %>
    <% if (journey.outcome === 'enquiry_submitted') { %>
      <span class="badge badge-success">Enquiry Submitted</span>
    <% } else if (journey.outcome === 'visit_booked') { %>
      <span class="badge badge-success">Visit Booked</span>
    <% } else if (journey.outcome === 'engaged') { %>
      <span class="badge badge-info">Engaged</span>
    <% } else if (journey.outcome === 'form_abandoned') { %>
      <span class="badge badge-warning">Form Abandoned</span>
    <% } else { %>
      <span class="badge badge-neutral">No Action</span>
    <% } %>
  </div>
</div>

<!-- KPI Cards -->
<div class="stats-grid">
  <div class="stat-card">
    <h3>First Seen</h3>
    <div class="value text-small" style="font-size: 1rem;"><%= new Date(journey.first_seen).toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' }) %></div>
  </div>
  <div class="stat-card">
    <h3>Last Seen</h3>
    <div class="value text-small" style="font-size: 1rem;"><%= new Date(journey.last_seen).toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' }) %></div>
  </div>
  <div class="stat-card highlight">
    <h3>Total Events</h3>
    <div class="value"><%= journey.event_count %></div>
  </div>
  <div class="stat-card <%= journey.time_to_action ? 'success' : '' %>">
    <h3>Time to Action</h3>
    <div class="value">
      <% if (journey.time_to_action) { %>
        <%= Math.floor(journey.time_to_action / 60) %>m <%= journey.time_to_action % 60 %>s
      <% } else { %>
        <span class="text-muted">-</span>
      <% } %>
    </div>
  </div>
</div>

<div class="grid-2 mb-6">
  <!-- Journey Overview -->
  <div class="card">
    <h2>Journey Overview</h2>
    <table>
      <tr>
        <th style="width: 140px; background: transparent; color: var(--text-muted); text-transform: none; letter-spacing: 0;">Entry Page</th>
        <td>
          <% if (journey.entry_page) { %>
            <a href="<%= journey.entry_page %>" target="_blank" class="entry-page-link" data-url="<%= journey.entry_page %>">
              <span class="page-display"></span>
            </a>
          <% } else { %>
            <span class="text-muted">Unknown</span>
          <% } %>
        </td>
      </tr>
      <tr>
        <th style="background: transparent; color: var(--text-muted); text-transform: none; letter-spacing: 0;">Referrer</th>
        <td>
          <% if (journey.entry_referrer) { %>
            <a href="<%= journey.entry_referrer %>" target="_blank" title="<%= journey.entry_referrer %>">
              <%= journey.entry_referrer.replace(/^https?:\/\/([^\/]+).*/, '$1') %>
            </a>
          <% } else { %>
            <span class="text-muted">Direct</span>
          <% } %>
        </td>
      </tr>
      <tr>
        <th style="background: transparent; color: var(--text-muted); text-transform: none; letter-spacing: 0;">Initial Intent</th>
        <td>
          <% if (journey.initial_intent) { %>
            <span class="badge badge-info"><%= journey.initial_intent %></span>
          <% } else { %>
            <span class="text-muted">Browsing</span>
          <% } %>
        </td>
      </tr>
      <tr>
        <th style="background: transparent; color: var(--text-muted); text-transform: none; letter-spacing: 0;">Pages Viewed</th>
        <td><strong><%= journey.page_sequence?.length || 0 %></strong> pages</td>
      </tr>
      <% if (journey.visitor_id) { %>
      <tr>
        <th style="background: transparent; color: var(--text-muted); text-transform: none; letter-spacing: 0;">Visitor ID</th>
        <td><code style="font-size: 0.8rem;"><%= journey.visitor_id.substring(0, 12) %>...</code></td>
      </tr>
      <% } %>
    </table>

    <% if (journey.loops && journey.loops.length > 0) { %>
    <div class="mt-4">
      <h4 style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 8px;">Loop Detection</h4>
      <div class="flex flex-wrap gap-2">
        <% journey.loops.forEach(loop => { %>
          <span class="badge badge-warning" title="This page was visited multiple times">
            <%= loop.url.replace(/https?:\/\/[^\/]+/, '').substring(0, 30) %> (x<%= loop.visits %>)
          </span>
        <% }) %>
      </div>
    </div>
    <% } %>
  </div>

  <!-- Engagement Score -->
  <div class="card">
    <h2>Engagement Score</h2>
    <div style="display: flex; align-items: center; justify-content: center; padding: 20px;">
      <%
        let score = 0;
        const eventCount = journey.event_count || 0;
        const pageCount = journey.page_sequence?.length || 0;

        score += Math.min(pageCount * 10, 30);
        score += Math.min(eventCount * 2, 30);

        if (journey.time_to_action) {
          score += Math.min(Math.floor(journey.time_to_action / 30), 20);
        }

        if (journey.outcome === 'enquiry_submitted' || journey.outcome === 'visit_booked') {
          score += 20;
        } else if (journey.outcome === 'engaged' || journey.outcome === 'form_abandoned') {
          score += 10;
        }

        score = Math.min(score, 100);

        let scoreColour = '#EF4444';
        if (score >= 70) scoreColour = '#10B981';
        else if (score >= 40) scoreColour = '#F59E0B';
      %>
      <div class="engagement-ring">
        <svg width="140" height="140" viewBox="0 0 140 140">
          <circle cx="70" cy="70" r="58" fill="none" stroke="var(--border-grey)" stroke-width="12" />
          <circle cx="70" cy="70" r="58" fill="none" stroke="<%= scoreColour %>" stroke-width="12"
            stroke-dasharray="<%= (score / 100) * 364 %> 364"
            stroke-linecap="round" />
        </svg>
        <div class="value" style="font-size: 2rem; color: <%= scoreColour %>;">
          <%= score %>
        </div>
      </div>
    </div>
    <div style="text-align: center;">
      <p class="text-muted text-small">
        <% if (score >= 70) { %>
          High engagement - likely to convert
        <% } else if (score >= 40) { %>
          Moderate engagement - showing interest
        <% } else { %>
          Low engagement - brief visit
        <% } %>
      </p>
    </div>
  </div>
</div>

<!-- Event Timeline - Snake Layout -->
<div class="card">
  <div class="flex justify-between items-center mb-4">
    <h2 style="margin-bottom: 0;">Event Timeline</h2>
    <label class="flex items-center gap-2" style="cursor: pointer;">
      <span class="text-small text-muted">Hide heartbeats</span>
      <label class="toggle-switch">
        <input type="checkbox" id="hideHeartbeats" checked onchange="toggleHeartbeats()">
        <span class="toggle-slider"></span>
      </label>
    </label>
  </div>

  <% if (!journey.events || journey.events.length === 0) { %>
    <div class="empty-state">
      <h3>No events recorded</h3>
      <p>No events have been captured for this journey yet.</p>
    </div>
  <% } else { %>
    <div class="snake-timeline" id="eventTimeline">
      <% journey.events.forEach((event, index) => { %>
        <div class="snake-event <%= event.event_type %>" data-event-type="<%= event.event_type %>">
          <div class="snake-event-card">
            <div class="snake-event-time">
              <%= new Date(event.occurred_at).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) %>
              <% if (index > 0) { %>
                <% const prevTime = new Date(journey.events[index-1].occurred_at).getTime(); %>
                <% const currTime = new Date(event.occurred_at).getTime(); %>
                <% const diff = Math.round((currTime - prevTime) / 1000); %>
                <span class="snake-event-diff">+<%= diff %>s</span>
              <% } %>
            </div>
            <div class="snake-event-type">
              <% if (event.event_type === 'page_view') { %>
                Page View
              <% } else if (event.event_type === 'cta_click') { %>
                CTA Click
              <% } else if (event.event_type === 'form_start') { %>
                Form Started
              <% } else if (event.event_type === 'form_submit') { %>
                Form Submitted
              <% } else if (event.event_type === 'form_abandon') { %>
                Form Abandoned
              <% } else if (event.event_type === 'scroll_depth') { %>
                Scroll
              <% } else if (event.event_type === 'time_on_page') { %>
                Time
              <% } else if (event.event_type === 'rage_click') { %>
                <span class="rage">Rage Click</span>
              <% } else if (event.event_type === 'exit_intent') { %>
                Exit Intent
              <% } else if (event.event_type === 'heartbeat') { %>
                Heartbeat
              <% } else { %>
                <%= event.event_type.replace(/_/g, ' ') %>
              <% } %>
            </div>
            <% if (event.page_url) { %>
              <a href="<%= event.page_url %>" target="_blank" class="snake-event-url" title="<%= event.page_url %>">
                <%= event.page_url.replace(/https?:\/\/[^\/]+/, '').substring(0, 25) %><%= event.page_url.replace(/https?:\/\/[^\/]+/, '').length > 25 ? '...' : '' %>
              </a>
            <% } %>
            <% if (event.cta_label && event.event_type !== 'page_view') { %>
              <div class="snake-event-label">"<%= event.cta_label.substring(0, 20) %><%= event.cta_label.length > 20 ? '...' : '' %>"</div>
            <% } %>
            <% if (event.intent_type) { %>
              <span class="badge badge-gold snake-event-intent"><%= event.intent_type %></span>
            <% } %>
          </div>
          <% if (index < journey.events.length - 1) { %>
            <div class="snake-arrow"></div>
          <% } %>
        </div>
      <% }) %>
    </div>
  <% } %>
</div>

<style>
  /* Snake Timeline Layout */
  .snake-timeline {
    display: flex;
    flex-wrap: wrap;
    gap: 0;
    padding: 20px 0;
  }

  .snake-event {
    display: flex;
    align-items: center;
    margin-bottom: 16px;
  }

  .snake-event[data-event-type="heartbeat"] {
    display: none;
  }

  .snake-event.show-heartbeat[data-event-type="heartbeat"] {
    display: flex;
  }

  .snake-event-card {
    background: var(--bg-card);
    border: 1px solid var(--border-grey);
    border-radius: 8px;
    padding: 12px 16px;
    min-width: 140px;
    max-width: 180px;
    text-align: center;
  }

  /* Colour coding for event types */
  .snake-event.page_view .snake-event-card {
    border-left: 3px solid #3B82F6;
  }
  .snake-event.cta_click .snake-event-card {
    border-left: 3px solid #F59E0B;
    background: rgba(245, 158, 11, 0.1);
  }
  .snake-event.form_start .snake-event-card,
  .snake-event.form_submit .snake-event-card {
    border-left: 3px solid #10B981;
    background: rgba(16, 185, 129, 0.1);
  }
  .snake-event.form_abandon .snake-event-card {
    border-left: 3px solid #EF4444;
    background: rgba(239, 68, 68, 0.1);
  }
  .snake-event.rage_click .snake-event-card {
    border-left: 3px solid #EF4444;
    background: rgba(239, 68, 68, 0.15);
  }
  .snake-event.scroll_depth .snake-event-card,
  .snake-event.heartbeat .snake-event-card {
    border-left: 3px solid #6B7280;
    opacity: 0.7;
  }

  .snake-event-time {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-bottom: 4px;
  }

  .snake-event-diff {
    color: var(--accent);
    margin-left: 4px;
  }

  .snake-event-type {
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--text-primary);
    margin-bottom: 4px;
  }

  .snake-event-type .rage {
    color: #EF4444;
  }

  .snake-event-url {
    display: block;
    font-size: 0.75rem;
    color: var(--accent) !important;
    text-decoration: none;
    margin-top: 4px;
    word-break: break-all;
  }

  .snake-event-url:hover {
    text-decoration: underline;
  }

  .snake-event-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-top: 4px;
    font-style: italic;
  }

  .snake-event-intent {
    margin-top: 6px;
    font-size: 0.65rem;
  }

  /* Arrow between events */
  .snake-arrow {
    width: 30px;
    height: 2px;
    background: var(--accent);
    position: relative;
    margin: 0 4px;
  }

  .snake-arrow::after {
    content: '';
    position: absolute;
    right: -2px;
    top: -4px;
    border: solid var(--accent);
    border-width: 0 2px 2px 0;
    padding: 4px;
    transform: rotate(-45deg);
  }

  /* Row direction alternation - handled by JS */
  .snake-timeline[data-row="even"] {
    flex-direction: row-reverse;
  }

  /* Turn arrow styling */
  .snake-turn-arrow {
    width: 100%;
    display: flex;
    justify-content: flex-end;
    padding: 8px 0;
  }

  .snake-turn-arrow.left {
    justify-content: flex-start;
  }

  .snake-turn-arrow svg {
    width: 40px;
    height: 40px;
    color: var(--accent);
  }
</style>

<% if (journey.page_sequence && journey.page_sequence.length > 0) { %>
<!-- Page Sequence / Journey Flow -->
<div class="card">
  <h2>Journey Flow</h2>
  <div class="journey-flow" id="journeyFlow">
    <% journey.page_sequence.forEach((page, index) => { %>
      <div class="journey-flow-item">
        <div class="journey-flow-page <%= index === journey.page_sequence.length - 1 && (journey.outcome === 'enquiry_submitted' || journey.outcome === 'visit_booked') ? 'conversion' : '' %>"
             data-url="<%= page.url || '' %>"
             title="<%= new Date(page.timestamp).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) %>">
          <span class="page-icon"></span>
          <span class="page-name"></span>
        </div>
        <% if (index < journey.page_sequence.length - 1) { %>
          <span class="journey-flow-arrow">→</span>
        <% } %>
      </div>
    <% }) %>
  </div>
  <p class="text-small text-muted mt-4" style="text-align: center;">
    <%= journey.page_sequence.length %> page<%= journey.page_sequence.length !== 1 ? 's' : '' %> visited •
    <%
      const firstTime = new Date(journey.page_sequence[0].timestamp).getTime();
      const lastTime = new Date(journey.page_sequence[journey.page_sequence.length - 1].timestamp).getTime();
      const totalSeconds = Math.round((lastTime - firstTime) / 1000);
    %>
    Total time: <%= totalSeconds < 60 ? totalSeconds + 's' : Math.floor(totalSeconds / 60) + 'm ' + (totalSeconds % 60) + 's' %>
  </p>
</div>
<% } %>

<script>
  function toggleHeartbeats() {
    const hideHeartbeats = document.getElementById('hideHeartbeats').checked;
    const heartbeatItems = document.querySelectorAll('[data-event-type="heartbeat"]');

    heartbeatItems.forEach(item => {
      if (hideHeartbeats) {
        item.classList.remove('show-heartbeat');
      } else {
        item.classList.add('show-heartbeat');
      }
    });

    // Re-layout the snake after toggling
    layoutSnakeTimeline();
  }

  function layoutSnakeTimeline() {
    const container = document.getElementById('eventTimeline');
    if (!container || !container.classList.contains('snake-timeline')) return;

    const events = Array.from(container.querySelectorAll('.snake-event')).filter(el => {
      return el.style.display !== 'none' && !el.classList.contains('snake-event') ||
             el.classList.contains('show-heartbeat') ||
             el.dataset.eventType !== 'heartbeat';
    });

    // Get visible events
    const visibleEvents = Array.from(container.querySelectorAll('.snake-event')).filter(el => {
      const isHeartbeat = el.dataset.eventType === 'heartbeat';
      const showHeartbeat = el.classList.contains('show-heartbeat');
      return !isHeartbeat || showHeartbeat;
    });

    // Calculate items per row based on container width
    const containerWidth = container.offsetWidth;
    const itemWidth = 180 + 38; // card width + arrow width
    const itemsPerRow = Math.max(2, Math.floor(containerWidth / itemWidth));

    // Group events into rows
    let currentRow = 0;
    visibleEvents.forEach((event, index) => {
      const rowIndex = Math.floor(index / itemsPerRow);
      const isEvenRow = rowIndex % 2 === 1;
      const positionInRow = index % itemsPerRow;

      // For even rows (1, 3, 5...), reverse the order visually
      if (isEvenRow) {
        event.style.order = (rowIndex * itemsPerRow) + (itemsPerRow - 1 - positionInRow);
      } else {
        event.style.order = index;
      }

      // Hide arrow on last item of each row (except last row)
      const isLastInRow = positionInRow === itemsPerRow - 1;
      const isLastEvent = index === visibleEvents.length - 1;
      const arrow = event.querySelector('.snake-arrow');
      if (arrow) {
        if (isLastInRow && !isLastEvent) {
          // Turn arrow - point down
          arrow.style.display = 'none';
        } else if (isLastEvent) {
          arrow.style.display = 'none';
        } else {
          arrow.style.display = 'block';
          // Flip arrow direction on even rows
          if (isEvenRow) {
            arrow.style.transform = 'rotate(180deg)';
          } else {
            arrow.style.transform = 'rotate(0deg)';
          }
        }
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    toggleHeartbeats();
    layoutSnakeTimeline();

    // Re-layout on window resize
    window.addEventListener('resize', layoutSnakeTimeline);

    // Populate friendly page names in journey flow
    document.querySelectorAll('.journey-flow-page').forEach(el => {
      const url = el.dataset.url;
      const iconEl = el.querySelector('.page-icon');
      const nameEl = el.querySelector('.page-name');
      if (iconEl) iconEl.textContent = getPageIcon(url);
      if (nameEl) nameEl.textContent = getPageName(url);
    });

    // Populate entry page link
    document.querySelectorAll('.entry-page-link').forEach(el => {
      const url = el.dataset.url;
      const displayEl = el.querySelector('.page-display');
      if (displayEl) {
        displayEl.innerHTML = `<span style="margin-right: 6px;">${getPageIcon(url)}</span>${getPageName(url)}`;
      }
    });

    // Populate snake timeline URLs with friendly names
    document.querySelectorAll('.snake-event-url').forEach(el => {
      const url = el.getAttribute('href');
      if (url) {
        el.textContent = getPageName(url);
      }
    });
  });
</script>
