<% layout('layout') -%>

<% if (typeof analyzed !== 'undefined') { %>
<div class="alert alert-success">
  Analysis completed successfully.
</div>
<% } %>

<% if (typeof error !== 'undefined') { %>
<div class="alert alert-info">
  Error: <%= error %>
</div>
<% } %>

<div class="flex justify-between items-center mb-4">
  <h2>AI Insights</h2>
  <form action="/insights/analyze" method="POST" style="display: inline;">
    <button type="submit" class="btn btn-primary">Run New Analysis</button>
  </form>
</div>

<% if (!insight) { %>
  <div class="card">
    <div class="alert alert-info">
      No analysis has been run yet. Click "Run New Analysis" to generate insights from your journey data.
    </div>
  </div>
<% } else { %>
  <div class="stats-grid">
    <div class="stat-card">
      <h3>Analysis Period</h3>
      <div class="value text-small"><%= insight.period_start %> to <%= insight.period_end %></div>
    </div>
    <div class="stat-card">
      <h3>Journeys Analyzed</h3>
      <div class="value"><%= insight.total_journeys %></div>
    </div>
    <div class="stat-card">
      <h3>Conversion Rate</h3>
      <div class="value"><%= insight.conversion_rate.toFixed(1) %>%</div>
    </div>
    <div class="stat-card">
      <h3>Generated</h3>
      <div class="value text-small"><%= new Date(insight.created_at).toLocaleString() %></div>
    </div>
  </div>

  <% if (insight.analysis_result) { %>
    <% const analysis = insight.analysis_result; %>

    <div class="card">
      <h2>Summary</h2>
      <p><%= analysis.summary %></p>

      <% if (analysis.keyMetrics) { %>
        <div class="stats-grid mt-4">
          <div class="stat-card">
            <h3>Conversion Rate</h3>
            <div class="value"><%= analysis.keyMetrics.conversionRate %>%</div>
          </div>
          <div class="stat-card">
            <h3>Avg Journey Length</h3>
            <div class="value"><%= analysis.keyMetrics.avgJourneyLength %></div>
            <div class="subtitle">events</div>
          </div>
          <div class="stat-card">
            <h3>Avg Time to Action</h3>
            <div class="value"><%= Math.floor(analysis.keyMetrics.avgTimeToAction / 60) %>m</div>
          </div>
        </div>
      <% } %>
    </div>

    <% if (analysis.patterns && analysis.patterns.length > 0) { %>
    <div class="card">
      <h2>Patterns Identified</h2>
      <table>
        <thead>
          <tr>
            <th>Pattern</th>
            <th>Description</th>
            <th>Frequency</th>
            <th>Impact</th>
          </tr>
        </thead>
        <tbody>
          <% analysis.patterns.forEach(pattern => { %>
            <tr>
              <td><strong><%= pattern.title %></strong></td>
              <td><%= pattern.description %></td>
              <td><%= pattern.frequency %></td>
              <td>
                <% if (pattern.impact === 'high') { %>
                  <span class="badge badge-danger">High</span>
                <% } else if (pattern.impact === 'medium') { %>
                  <span class="badge badge-warning">Medium</span>
                <% } else { %>
                  <span class="badge badge-info">Low</span>
                <% } %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% } %>

    <% if (analysis.frictionPoints && analysis.frictionPoints.length > 0) { %>
    <div class="card">
      <h2>Friction Points</h2>
      <table>
        <thead>
          <tr>
            <th>Location</th>
            <th>Issue</th>
            <th>Evidence</th>
            <th>Severity</th>
          </tr>
        </thead>
        <tbody>
          <% analysis.frictionPoints.forEach(point => { %>
            <tr>
              <td><strong><%= point.location %></strong></td>
              <td><%= point.issue %></td>
              <td class="text-small"><%= point.evidence %></td>
              <td>
                <% if (point.severity === 'high') { %>
                  <span class="badge badge-danger">High</span>
                <% } else if (point.severity === 'medium') { %>
                  <span class="badge badge-warning">Medium</span>
                <% } else { %>
                  <span class="badge badge-info">Low</span>
                <% } %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% } %>

    <% if (analysis.recommendations && analysis.recommendations.length > 0) { %>
    <div class="card">
      <h2>Recommendations</h2>
      <% analysis.recommendations.forEach((rec, index) => { %>
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e2e8f0;">
          <div class="flex justify-between items-center">
            <h3 style="margin-bottom: 8px;"><%= index + 1 %>. <%= rec.title %></h3>
            <% if (rec.priority === 'high') { %>
              <span class="badge badge-danger">High Priority</span>
            <% } else if (rec.priority === 'medium') { %>
              <span class="badge badge-warning">Medium Priority</span>
            <% } else { %>
              <span class="badge badge-info">Low Priority</span>
            <% } %>
          </div>
          <p><%= rec.description %></p>
          <% if (rec.expectedImpact) { %>
            <p class="text-small text-muted"><strong>Expected Impact:</strong> <%= rec.expectedImpact %></p>
          <% } %>
          <% if (rec.implementation) { %>
            <p class="text-small text-muted"><strong>Implementation:</strong> <%= rec.implementation %></p>
          <% } %>
        </div>
      <% }) %>
    </div>
    <% } %>

    <% if (analysis.quickWins && analysis.quickWins.length > 0) { %>
    <div class="card">
      <h2>Quick Wins</h2>
      <ul>
        <% analysis.quickWins.forEach(win => { %>
          <li style="margin-bottom: 8px;"><%= win %></li>
        <% }) %>
      </ul>
    </div>
    <% } %>
  <% } %>

  <% if (history && history.length > 1) { %>
  <div class="card">
    <h2>Analysis History</h2>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Period</th>
          <th>Journeys</th>
          <th>Conversion Rate</th>
        </tr>
      </thead>
      <tbody>
        <% history.forEach(h => { %>
          <tr>
            <td><%= new Date(h.created_at).toLocaleDateString() %></td>
            <td><%= h.period_start %> - <%= h.period_end %></td>
            <td><%= h.total_journeys %></td>
            <td><%= h.conversion_rate.toFixed(1) %>%</td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
  <% } %>
<% } %>
