<% if (typeof analyzed !== 'undefined') { %>
<div class="alert alert-success slide-in">
  Analysis completed successfully.
</div>
<% } %>

<% if (typeof error !== 'undefined') { %>
<div class="alert alert-danger">
  Error: <%= error %>
</div>
<% } %>

<div class="flex justify-between items-center mb-4">
  <h2 style="font-size: 1.5rem;">AI Insights</h2>
  <form action="/insights/analyze" method="POST" style="display: inline;">
    <button type="submit" class="btn btn-primary">Run New Analysis</button>
  </form>
</div>

<% if (!insight) { %>
  <div class="card">
    <div class="empty-state">
      <h3>No analysis yet</h3>
      <p>Click "Run New Analysis" to generate AI-powered insights from your journey data.</p>
      <p class="text-small text-muted mt-4">The AI will analyse visitor behaviour patterns, identify friction points, and provide actionable recommendations.</p>
    </div>
  </div>
<% } else { %>
  <!-- Analysis Overview Stats -->
  <div class="stats-grid">
    <div class="stat-card">
      <h3>Analysis Period</h3>
      <div class="value text-small" style="font-size: 1rem;">
        <%= new Date(insight.period_start).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) %> - <%= new Date(insight.period_end).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) %>
      </div>
    </div>
    <div class="stat-card highlight">
      <h3>Journeys Analysed</h3>
      <div class="value"><%= insight.total_journeys %></div>
    </div>
    <div class="stat-card <%= insight.conversion_rate >= 5 ? 'success' : insight.conversion_rate >= 2 ? '' : '' %>">
      <h3>Conversion Rate</h3>
      <div class="value"><%= insight.conversion_rate.toFixed(1) %>%</div>
    </div>
    <div class="stat-card">
      <h3>Generated</h3>
      <div class="value text-small" style="font-size: 1rem;"><%= new Date(insight.created_at).toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' }) %></div>
    </div>
  </div>

  <% if (insight.analysis_result) { %>
    <% const analysis = typeof insight.analysis_result === 'string' ? JSON.parse(insight.analysis_result) : insight.analysis_result; %>

    <!-- Summary Card -->
    <div class="card mb-6">
      <h2>Executive Summary</h2>
      <p style="font-size: 1.05rem; line-height: 1.8; color: var(--text-muted);">
        <%= analysis.summary %>
      </p>

      <% if (analysis.keyMetrics) { %>
        <div class="stats-grid mt-6">
          <div class="stat-card" style="background: var(--paper);">
            <h3>Conversion Rate</h3>
            <div class="value text-gold"><%= analysis.keyMetrics.conversionRate %>%</div>
          </div>
          <div class="stat-card" style="background: var(--paper);">
            <h3>Avg Journey Length</h3>
            <div class="value"><%= analysis.keyMetrics.avgJourneyLength %></div>
            <div class="subtitle">events per journey</div>
          </div>
          <div class="stat-card" style="background: var(--paper);">
            <h3>Avg Time to Action</h3>
            <div class="value"><%= Math.floor(analysis.keyMetrics.avgTimeToAction / 60) %>m</div>
            <div class="subtitle"><%= analysis.keyMetrics.avgTimeToAction % 60 %>s</div>
          </div>
        </div>
      <% } %>
    </div>

    <!-- Quick Wins -->
    <% if (analysis.quickWins && analysis.quickWins.length > 0) { %>
    <div class="card mb-6" style="border-left: 4px solid var(--success);">
      <h2>Quick Wins</h2>
      <p class="text-muted mb-4">Low-effort changes that can have immediate impact</p>
      <div class="grid-2">
        <% analysis.quickWins.forEach((win, index) => { %>
          <div style="display: flex; align-items: flex-start; gap: 12px; padding: 16px; background: var(--paper); border-radius: 12px;">
            <div style="width: 32px; height: 32px; background: var(--success-light); color: var(--success); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">
              <%= index + 1 %>
            </div>
            <div><%= win %></div>
          </div>
        <% }) %>
      </div>
    </div>
    <% } %>

    <!-- Patterns Identified -->
    <% if (analysis.patterns && analysis.patterns.length > 0) { %>
    <div class="card mb-6">
      <h2>Patterns Identified</h2>
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>Pattern</th>
              <th>Description</th>
              <th>Frequency</th>
              <th>Impact</th>
            </tr>
          </thead>
          <tbody>
            <% analysis.patterns.forEach(pattern => { %>
              <tr>
                <td><strong><%= pattern.title %></strong></td>
                <td class="text-small"><%= pattern.description %></td>
                <td><span class="badge badge-info"><%= pattern.frequency %></span></td>
                <td>
                  <% if (pattern.impact === 'high') { %>
                    <span class="badge badge-danger">High</span>
                  <% } else if (pattern.impact === 'medium') { %>
                    <span class="badge badge-warning">Medium</span>
                  <% } else { %>
                    <span class="badge badge-info">Low</span>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
    <% } %>

    <!-- Friction Points -->
    <% if (analysis.frictionPoints && analysis.frictionPoints.length > 0) { %>
    <div class="card mb-6" style="border-left: 4px solid var(--danger);">
      <h2>Friction Points</h2>
      <p class="text-muted mb-4">Areas where visitors are struggling or dropping off</p>
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>Location</th>
              <th>Issue</th>
              <th>Evidence</th>
              <th>Severity</th>
            </tr>
          </thead>
          <tbody>
            <% analysis.frictionPoints.forEach(point => { %>
              <tr>
                <td><strong><%= point.location %></strong></td>
                <td><%= point.issue %></td>
                <td class="text-small text-muted"><%= point.evidence %></td>
                <td>
                  <% if (point.severity === 'high') { %>
                    <span class="badge badge-danger">High</span>
                  <% } else if (point.severity === 'medium') { %>
                    <span class="badge badge-warning">Medium</span>
                  <% } else { %>
                    <span class="badge badge-info">Low</span>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
    <% } %>

    <!-- Recommendations -->
    <% if (analysis.recommendations && analysis.recommendations.length > 0) { %>
    <div class="card mb-6">
      <h2>Recommendations</h2>
      <div style="display: flex; flex-direction: column; gap: 20px;">
        <% analysis.recommendations.forEach((rec, index) => { %>
          <div style="padding: 20px; background: var(--paper); border-radius: 12px; border-left: 4px solid <%= rec.priority === 'high' ? 'var(--danger)' : rec.priority === 'medium' ? 'var(--warning)' : 'var(--info)' %>;">
            <div class="flex justify-between items-center mb-2">
              <h3 style="font-size: 1.1rem; margin: 0; display: flex; align-items: center; gap: 8px;">
                <span style="width: 28px; height: 28px; background: var(--bg-card); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 700;">
                  <%= index + 1 %>
                </span>
                <%= rec.title %>
              </h3>
              <% if (rec.priority === 'high') { %>
                <span class="badge badge-danger">High Priority</span>
              <% } else if (rec.priority === 'medium') { %>
                <span class="badge badge-warning">Medium Priority</span>
              <% } else { %>
                <span class="badge badge-info">Low Priority</span>
              <% } %>
            </div>
            <p style="margin: 12px 0; color: var(--text-muted);"><%= rec.description %></p>
            <% if (rec.expectedImpact) { %>
              <div class="flex gap-4 mt-4" style="flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 6px;" class="text-small">
                  <strong>Expected Impact:</strong>
                  <span class="text-muted"><%= rec.expectedImpact %></span>
                </div>
              </div>
            <% } %>
            <% if (rec.implementation) { %>
              <div class="mt-2 text-small" style="display: flex; align-items: center; gap: 6px;">
                <strong>Implementation:</strong>
                <span class="text-muted"><%= rec.implementation %></span>
              </div>
            <% } %>
          </div>
        <% }) %>
      </div>
    </div>
    <% } %>
  <% } %>

  <!-- Analysis History -->
  <% if (history && history.length > 1) { %>
  <div class="card">
    <h2>Analysis History</h2>
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Period</th>
            <th>Journeys</th>
            <th>Conversion Rate</th>
            <th>Trend</th>
          </tr>
        </thead>
        <tbody>
          <% history.forEach((h, index) => { %>
            <tr>
              <td><%= new Date(h.created_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) %></td>
              <td class="text-small text-muted">
                <%= new Date(h.period_start).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) %> - <%= new Date(h.period_end).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) %>
              </td>
              <td><%= h.total_journeys %></td>
              <td><strong><%= h.conversion_rate.toFixed(1) %>%</strong></td>
              <td>
                <%
                  if (index < history.length - 1) {
                    const prevRate = history[index + 1].conversion_rate;
                    const diff = h.conversion_rate - prevRate;
                    if (diff > 0) {
                %>
                  <span class="badge badge-success">+<%= diff.toFixed(1) %>%</span>
                <%
                    } else if (diff < 0) {
                %>
                  <span class="badge badge-danger"><%= diff.toFixed(1) %>%</span>
                <%
                    } else {
                %>
                  <span class="badge badge-neutral">0%</span>
                <%
                    }
                  } else {
                %>
                  <span class="text-muted">-</span>
                <%
                  }
                %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
  <% } %>
<% } %>
