<% if (typeof analyzed !== 'undefined') { %>
<div class="alert alert-success slide-in">
  Analysis completed successfully.
</div>
<% } %>

<% if (typeof error !== 'undefined') { %>
<div class="alert alert-danger">
  Error: <%= error %>
</div>
<% } %>

<div class="flex justify-between items-center mb-4">
  <h2 style="font-size: 1.5rem;">AI Insights</h2>
  <div class="flex gap-4 items-center">
    <div id="screenshot-controls" class="flex gap-2 items-center">
      <span id="screenshot-status" class="text-small text-muted">Loading...</span>
      <button type="button" id="capture-screenshots-btn" class="btn btn-secondary" onclick="captureScreenshots()">
        ðŸ“· Capture Screenshots
      </button>
    </div>
    <form action="/insights/analyze" method="POST" style="display: inline;">
      <button type="submit" class="btn btn-primary">Run New Analysis</button>
    </form>
  </div>
</div>

<script>
// Screenshot management
const siteId = '<%= typeof siteId !== "undefined" ? siteId : "2" %>';

async function loadScreenshotStatus() {
  try {
    const response = await fetch(`/screenshots/${siteId}/status`);
    const data = await response.json();
    const statusEl = document.getElementById('screenshot-status');

    if (data.hasScreenshots) {
      statusEl.innerHTML = `<span class="text-success">âœ“ ${data.totalCount} screenshots</span>`;
    } else {
      statusEl.innerHTML = `<span class="text-muted">No screenshots yet</span>`;
    }
  } catch (error) {
    document.getElementById('screenshot-status').innerHTML = '<span class="text-muted">-</span>';
  }
}

async function captureScreenshots() {
  const btn = document.getElementById('capture-screenshots-btn');
  const statusEl = document.getElementById('screenshot-status');

  btn.disabled = true;
  btn.textContent = 'ðŸ“· Capturing...';
  statusEl.innerHTML = '<span class="text-muted">Capturing pages...</span>';

  try {
    const response = await fetch(`/screenshots/capture/${siteId}`, { method: 'POST' });
    const data = await response.json();

    if (data.success) {
      statusEl.innerHTML = `<span class="text-success">âœ“ ${data.captured} captured</span>`;
      alert(`Screenshots captured!\n\nCaptured: ${data.captured}\nFailed: ${data.failed}\n\nThe AI will now include these in analysis.`);
    } else {
      statusEl.innerHTML = `<span class="text-danger">âœ— ${data.error || 'Failed'}</span>`;
      alert('Screenshot capture failed: ' + (data.error || 'Unknown error'));
    }
  } catch (error) {
    statusEl.innerHTML = '<span class="text-danger">âœ— Error</span>';
    alert('Screenshot capture failed: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'ðŸ“· Capture Screenshots';
    loadScreenshotStatus();
  }
}

// Load status on page load
document.addEventListener('DOMContentLoaded', loadScreenshotStatus);
</script>

<% if (!insight) { %>
  <div class="card">
    <div class="empty-state">
      <h3>No analysis yet</h3>
      <p>Click "Run New Analysis" to generate AI-powered insights from your journey data.</p>
      <p class="text-small text-muted mt-4">The AI will analyse how your website is performing and recommend improvements.</p>
    </div>
  </div>
<% } else { %>
  <!-- Analysis Overview Stats -->
  <div class="stats-grid">
    <div class="stat-card">
      <h3>Analysis Period</h3>
      <div class="value text-small" style="font-size: 1rem;">
        <%= new Date(insight.period_start).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) %> - <%= new Date(insight.period_end).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) %>
      </div>
    </div>
    <div class="stat-card highlight">
      <h3>Journeys Analysed</h3>
      <div class="value"><%= insight.total_journeys %></div>
    </div>
    <div class="stat-card">
      <h3>Conversion Rate</h3>
      <div class="value"><%= insight.conversion_rate.toFixed(1) %>%</div>
    </div>
    <div class="stat-card">
      <h3>Generated</h3>
      <div class="value text-small" style="font-size: 1rem;"><%= new Date(insight.created_at).toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' }) %></div>
    </div>
  </div>

  <% if (insight.analysis_result) { %>
    <% const analysis = typeof insight.analysis_result === 'string' ? JSON.parse(insight.analysis_result) : insight.analysis_result; %>

    <!-- Summary Card -->
    <div class="card mb-6">
      <h2>Executive Summary</h2>
      <p style="font-size: 1.1rem; line-height: 1.8; color: var(--text-muted);">
        <%= analysis.summary %>
      </p>

      <% if (analysis.performance) { %>
        <div class="stats-grid mt-6">
          <div class="stat-card metric-card">
            <h3>Conversion Rate</h3>
            <div class="value text-gold"><%= analysis.performance.conversionRate %></div>
          </div>
          <div class="stat-card metric-card">
            <h3>Total Visitors</h3>
            <div class="value"><%= analysis.performance.totalVisitors %></div>
          </div>
          <div class="stat-card metric-card">
            <h3>Total Conversions</h3>
            <div class="value"><%= analysis.performance.totalConversions %></div>
          </div>
          <div class="stat-card metric-card">
            <h3>Bounce Rate</h3>
            <div class="value"><%= analysis.performance.bounceRate %></div>
          </div>
        </div>
        <% if (analysis.performance.verdict) { %>
          <div class="mt-4" style="padding: 16px; background: var(--paper); border-radius: 8px;">
            <strong>Verdict:</strong> <span class="text-muted"><%= analysis.performance.verdict %></span>
          </div>
        <% } %>
      <% } %>
    </div>

    <!-- Visitor Journey -->
    <% if (analysis.visitorJourney) { %>
    <div class="card mb-6">
      <h2>Visitor Journey</h2>
      <p class="text-muted mb-4">How visitors navigate through your website</p>

      <div class="grid-3 mb-6">
        <div style="padding: 16px; background: var(--paper); border-radius: 8px;">
          <h4 style="color: var(--gold); margin-bottom: 12px;">Entry Pages</h4>
          <p class="text-small text-muted mb-2">Where visitors land</p>
          <ul style="list-style: none; padding: 0; margin: 0;">
            <% if (analysis.visitorJourney.topEntryPages) { %>
              <% analysis.visitorJourney.topEntryPages.forEach(page => { %>
                <li style="padding: 4px 0; border-bottom: 1px solid var(--border-color);"><%= page %></li>
              <% }) %>
            <% } %>
          </ul>
        </div>

        <div style="padding: 16px; background: var(--paper); border-radius: 8px;">
          <h4 style="color: var(--gold); margin-bottom: 12px;">Common Paths</h4>
          <p class="text-small text-muted mb-2">Typical navigation patterns</p>
          <ul style="list-style: none; padding: 0; margin: 0;">
            <% if (analysis.visitorJourney.commonPaths) { %>
              <% analysis.visitorJourney.commonPaths.forEach(path => { %>
                <li style="padding: 4px 0; border-bottom: 1px solid var(--border-color); font-size: 0.85rem;"><%= path %></li>
              <% }) %>
            <% } %>
          </ul>
        </div>

        <div style="padding: 16px; background: var(--paper); border-radius: 8px;">
          <h4 style="color: var(--danger); margin-bottom: 12px;">Exit Pages</h4>
          <p class="text-small text-muted mb-2">Where visitors leave</p>
          <ul style="list-style: none; padding: 0; margin: 0;">
            <% if (analysis.visitorJourney.topExitPages) { %>
              <% analysis.visitorJourney.topExitPages.forEach(page => { %>
                <li style="padding: 4px 0; border-bottom: 1px solid var(--border-color);"><%= page %></li>
              <% }) %>
            <% } %>
          </ul>
        </div>
      </div>

      <% if (analysis.visitorJourney.journeyInsight) { %>
        <div style="padding: 16px; background: var(--paper); border-radius: 8px; border-left: 4px solid var(--gold);">
          <strong>Journey Insight:</strong>
          <p class="text-muted mt-2" style="margin-bottom: 0;"><%= analysis.visitorJourney.journeyInsight %></p>
        </div>
      <% } %>
    </div>
    <% } %>

    <!-- What's Working -->
    <% if (analysis.whatsWorking && analysis.whatsWorking.length > 0) { %>
    <div class="card mb-6" style="border-left: 4px solid var(--success);">
      <h2>What's Working Well</h2>
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <% analysis.whatsWorking.forEach(item => { %>
          <div style="padding: 16px; background: var(--paper); border-radius: 8px;">
            <strong style="color: var(--success);"><%= item.finding %></strong>
            <p class="text-muted text-small mt-2" style="margin-bottom: 0;"><%= item.evidence %></p>
          </div>
        <% }) %>
      </div>
    </div>
    <% } %>

    <!-- Problem Areas -->
    <% if (analysis.problemAreas && analysis.problemAreas.length > 0) { %>
    <div class="card mb-6" style="border-left: 4px solid var(--danger);">
      <h2>Problem Areas</h2>
      <p class="text-muted mb-4">Pages or areas where visitors are struggling or dropping off</p>
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>Page</th>
              <th>Problem</th>
              <th>Evidence</th>
              <th>Impact</th>
            </tr>
          </thead>
          <tbody>
            <% analysis.problemAreas.forEach(problem => { %>
              <tr>
                <td><strong><%= problem.page %></strong></td>
                <td><%= problem.problem %></td>
                <td class="text-small text-muted"><%= problem.evidence %></td>
                <td>
                  <% if (problem.impact === 'high') { %>
                    <span class="badge badge-danger">High</span>
                  <% } else if (problem.impact === 'medium') { %>
                    <span class="badge badge-warning">Medium</span>
                  <% } else { %>
                    <span class="badge badge-info">Low</span>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
    <% } %>

    <!-- Legacy support for old frictionPoints format -->
    <% if (analysis.frictionPoints && analysis.frictionPoints.length > 0 && !analysis.problemAreas) { %>
    <div class="card mb-6" style="border-left: 4px solid var(--danger);">
      <h2>Friction Points</h2>
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>Location</th>
              <th>Issue</th>
              <th>Evidence</th>
              <th>Severity</th>
            </tr>
          </thead>
          <tbody>
            <% analysis.frictionPoints.forEach(point => { %>
              <tr>
                <td><strong><%= point.location %></strong></td>
                <td><%= point.issue %></td>
                <td><%= point.evidence %></td>
                <td>
                  <% if (point.severity === 'high') { %>
                    <span class="badge badge-danger">High</span>
                  <% } else if (point.severity === 'medium') { %>
                    <span class="badge badge-warning">Medium</span>
                  <% } else { %>
                    <span class="badge badge-info">Low</span>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
    <% } %>

    <!-- Recommendations -->
    <% if (analysis.recommendations && analysis.recommendations.length > 0) { %>
    <div class="card mb-6">
      <h2>Recommendations</h2>
      <p class="text-muted mb-4">Prioritised actions to improve website performance</p>
      <div style="display: flex; flex-direction: column; gap: 20px;">
        <% analysis.recommendations.forEach((rec, index) => { %>
          <div style="padding: 20px; background: var(--paper); border-radius: 12px; border-left: 4px solid <%= rec.priority === 1 || rec.priority === 'high' ? 'var(--danger)' : rec.priority === 2 || rec.priority === 'medium' ? 'var(--warning)' : 'var(--info)' %>;">
            <div class="flex justify-between items-center mb-2">
              <h3 style="font-size: 1.1rem; margin: 0; display: flex; align-items: center; gap: 8px;">
                <span style="width: 28px; height: 28px; background: var(--bg-card); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 700;">
                  <%= rec.priority || (index + 1) %>
                </span>
                <%= rec.action || rec.title %>
              </h3>
              <% if (rec.priority === 1 || rec.priority === 'high') { %>
                <span class="badge badge-danger">High Priority</span>
              <% } else if (rec.priority === 2 || rec.priority === 'medium') { %>
                <span class="badge badge-warning">Medium Priority</span>
              <% } else { %>
                <span class="badge badge-info">Low Priority</span>
              <% } %>
            </div>
            <% if (rec.why || rec.description) { %>
              <p style="margin: 12px 0; color: var(--text-muted);"><%= rec.why || rec.description %></p>
            <% } %>
            <% if (rec.expectedResult || rec.expectedImpact) { %>
              <div class="flex gap-4 mt-4" style="flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 6px;" class="text-small">
                  <strong>Expected Result:</strong>
                  <span class="text-muted"><%= rec.expectedResult || rec.expectedImpact %></span>
                </div>
              </div>
            <% } %>
          </div>
        <% }) %>
      </div>
    </div>
    <% } %>

    <!-- Quick Wins -->
    <% if (analysis.quickWins && analysis.quickWins.length > 0) { %>
    <div class="card mb-6" style="border-left: 4px solid var(--success);">
      <h2>Quick Wins</h2>
      <p class="text-muted mb-4">Simple changes that could help immediately</p>
      <div class="grid-2">
        <% analysis.quickWins.forEach((win, index) => { %>
          <div class="quick-win-item">
            <div class="quick-win-number">
              <%= index + 1 %>
            </div>
            <div class="quick-win-text"><%= win %></div>
          </div>
        <% }) %>
      </div>
    </div>
    <% } %>
  <% } %>

  <!-- Analysis History -->
  <% if (history && history.length > 1) { %>
  <div class="card">
    <h2>Analysis History</h2>
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Period</th>
            <th>Journeys</th>
            <th>Conversion Rate</th>
            <th>Trend</th>
          </tr>
        </thead>
        <tbody>
          <% history.forEach((h, index) => { %>
            <tr>
              <td><%= new Date(h.created_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) %></td>
              <td>
                <%= new Date(h.period_start).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) %> - <%= new Date(h.period_end).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) %>
              </td>
              <td><%= h.total_journeys %></td>
              <td><strong><%= h.conversion_rate.toFixed(1) %>%</strong></td>
              <td>
                <%
                  if (index < history.length - 1) {
                    const prevRate = history[index + 1].conversion_rate;
                    const diff = h.conversion_rate - prevRate;
                    if (diff > 0) {
                %>
                  <span class="badge badge-success">+<%= diff.toFixed(1) %>%</span>
                <%
                    } else if (diff < 0) {
                %>
                  <span class="badge badge-danger"><%= diff.toFixed(1) %>%</span>
                <%
                    } else {
                %>
                  <span class="badge badge-neutral">0%</span>
                <%
                    }
                  } else {
                %>
                  <span class="text-muted">-</span>
                <%
                  }
                %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
  <% } %>
<% } %>
